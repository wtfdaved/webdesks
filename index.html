<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO & METADATA -->
    <title>WebDesks OS | The Ultimate Privacy-First WFH Workspace</title>
    <meta name="description" content="WebDesks is an all-in-one browser-based productivity suite. No installation, 100% private, runs locally. Tools include PDF merger, screen recorder, alarm clock, and project boards.">
    <meta name="keywords" content="browser OS, WFH tools, privacy productivity, online alarm clock, PDF merger local, screen recorder no install, task management browser">
    <meta name="author" content="WebDesks">
    <meta name="theme-color" content="#4f46e5">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://webdesks.app/">
    <meta property="og:title" content="WebDesks OS | Privacy-First Browser Workspace">
    <meta property="og:description" content="A powerful suite of productivity tools that run entirely in your browser.">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="WebDesks OS">
    <meta property="twitter:description" content="The ultimate browser-based workspace for remote professionals.">

    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñ•Ô∏è</text></svg>">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --accent: #4f46e5; 
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.4);
        }
        
        .dark { 
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.05);
        }

        html {
            scroll-behavior: smooth;
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }

        .dark * {
            scrollbar-color: #334155 transparent;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(-45deg, #eef2ff, #f5f3ff, #f0f9ff, #faf5ff);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            overflow: hidden;
            transition: background 0.5s ease;
        }

        .dark body { 
            background: linear-gradient(-45deg, #020617, #0f172a, #1e1b4b, #0f172a);
        }

        @keyframes gradientBG { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-hover:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
        }

        .dark .glass-hover:hover {
            background: rgba(30, 41, 59, 0.8);
        }

        /* Tab Transitions */
        .tab-content { 
            height: 100%; 
            width: 100%; 
            position: absolute; 
            inset: 0; 
            padding: 1.5rem; 
            overflow-y: auto;
            scroll-behavior: smooth;
            opacity: 0;
            transform: translateY(20px) scale(0.96);
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 0;
            will-change: transform, opacity;
        }

        .tab-content.active { 
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
            z-index: 10;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 20px;
            transition: background 0.3s;
        }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Panic Mode */
        .panic-mode main { 
            filter: blur(60px) grayscale(100%) brightness(0.3); 
            pointer-events: none; 
            transform: scale(0.95);
        }
        
        .panic-mode aside {
            opacity: 0;
            pointer-events: none;
        }

        /* Zen Mode */
        .zen-mode aside { display: none !important; }
        .zen-mode #exit-zen-btn { display: flex !important; }

        /* Typography */
        .timer-font { 
            font-family: 'JetBrains Mono', monospace; 
            font-variant-numeric: tabular-nums;
        }

        /* Interactive Elements */
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(79, 70, 229, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* Navigation Active State */
        .nav-btn {
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 0;
            background: #4f46e5;
            transition: height 0.3s;
            border-radius: 0 4px 4px 0;
        }

        .nav-btn.active::before {
            height: 60%;
        }

        .nav-btn.active {
            background: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
        }

        .nav-btn.active i {
            transform: scale(1.1);
        }

        .dark .nav-btn.active {
            background: rgba(79, 70, 229, 0.2);
            color: #818cf8;
        }

        /* Animations */
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .animate-pulse-soft {
            animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Input Styling */
        input, textarea, select {
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Alarm Ringing Animation */
        @keyframes ring {
            0%, 100% { transform: rotate(0deg); }
            10% { transform: rotate(15deg); }
            20% { transform: rotate(-15deg); }
            30% { transform: rotate(10deg); }
            40% { transform: rotate(-10deg); }
            50% { transform: rotate(5deg); }
            60% { transform: rotate(-5deg); }
            70% { transform: rotate(0deg); }
        }

        .ringing {
            animation: ring 2s ease-in-out infinite;
        }

        /* Focus Town Scene */
        #ft-scene {
            position: relative; height: 280px; overflow: hidden; border-radius: 1.5rem;
            background: linear-gradient(180deg, #bfdbfe 0%, #dbeafe 55%, #bbf7d0 80%, #4ade80 100%);
            transition: background 1.5s ease;
        }
        #ft-scene.ft-session-active {
            background: linear-gradient(180deg, #7dd3fc 0%, #bfdbfe 55%, #bbf7d0 80%, #4ade80 100%);
        }
        .dark #ft-scene {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 55%, #14532d 80%, #166534 100%);
        }
        .ft-ground {
            position: absolute; bottom: 40px; left: 0; right: 0; height: 22px;
            background: linear-gradient(180deg, #86efac, #4ade80);
        }
        .dark .ft-ground { background: linear-gradient(180deg, #15803d, #166534); }
        .ft-road {
            position: absolute; bottom: 0; left: 0; right: 0; height: 42px;
            background: #94a3b8;
        }
        .dark .ft-road { background: #334155; }
        .ft-road-line {
            position: absolute; top: 50%; left: 0; right: 0; height: 3px;
            background: repeating-linear-gradient(90deg, rgba(255,255,255,0.5) 0 28px, transparent 28px 56px);
            transform: translateY(-50%);
        }
        .ft-building-row {
            position: absolute; bottom: 60px; left: 0; right: 0;
            display: flex; align-items: flex-end; justify-content: center;
            gap: 3px; padding: 0 16px; flex-wrap: nowrap;
        }
        .ft-building { line-height: 1; display: inline-block; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.18)); user-select: none; }
        .ft-mountains {
            position: absolute; bottom: 78px; left: 0; right: 0;
            display: flex; justify-content: center; gap: 4px;
            font-size: 2.8rem; opacity: 0.22; pointer-events: none; user-select: none;
        }
        .ft-sky-obj {
            position: absolute; pointer-events: none; user-select: none;
        }
        .ft-cloud {
            font-size: 1.4rem; opacity: 0.75;
            animation: ft-cloud linear infinite;
        }
        .ft-citizen-row {
            position: absolute; bottom: 5px; left: 0; right: 0; height: 34px;
            overflow: hidden; pointer-events: none;
        }
        .ft-citizen {
            position: absolute; font-size: 1.15rem; user-select: none;
            animation: ft-walk-r linear infinite; bottom: 1px;
        }
        .ft-citizen.rev { animation-name: ft-walk-l; }
        .ft-vehicle {
            position: absolute; font-size: 1.25rem; bottom: 5px; user-select: none;
            animation: ft-drive-r linear infinite;
        }
        .ft-vehicle.rev { animation-name: ft-drive-l; bottom: 12px; }
        @keyframes ft-cloud {
            from { transform: translateX(-100px); }
            to { transform: translateX(110vw); }
        }
        @keyframes ft-walk-r {
            from { transform: translateX(-50px); }
            to { transform: translateX(calc(100vw + 50px)); }
        }
        @keyframes ft-walk-l {
            from { transform: translateX(calc(100vw + 50px)) scaleX(-1); }
            to { transform: translateX(-50px) scaleX(-1); }
        }
        @keyframes ft-drive-r {
            from { transform: translateX(-80px); }
            to { transform: translateX(calc(100vw + 80px)); }
        }
        @keyframes ft-drive-l {
            from { transform: translateX(calc(100vw + 80px)) scaleX(-1); }
            to { transform: translateX(-80px) scaleX(-1); }
        }
        @keyframes ft-stage-up {
            0%,100% { transform: scale(1); filter: brightness(1); }
            40% { transform: scale(1.04); filter: brightness(1.25); }
        }

        /* On Air Overlay */
        .onair-overlay {
            background: radial-gradient(circle at center, rgba(220, 38, 38, 0.9) 0%, rgba(153, 27, 27, 1) 100%);
        }

        /* Canvas cursor */
        #wb-canvas { cursor: crosshair; touch-action: none; }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .tab-content { padding: 1rem; }
            .timer-font { font-size: 3rem !important; }
        }

        /* Dragging styles */
        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .drop-zone {
            border: 2px dashed #4f46e5;
            background: rgba(79, 70, 229, 0.05);
        }

        /* Persistent Header */
        #app-header {
            height: 64px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--glass-border);
        }

        #app-body {
            flex: 1;
            overflow: hidden;
        }

        /* Header alarm bell active state */
        .alarm-active {
            animation: ring 2s ease-in-out infinite;
            color: #f97316;
        }

        /* Zen mode: hide header too */
        .zen-mode #app-header { display: none !important; }
        .zen-mode #app-body { height: 100vh; }

        /* Panic mode: blur header */
        .panic-mode #app-header {
            filter: blur(20px);
            pointer-events: none;
        }

        /* Color picker swatch */
        .color-swatch {
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.15s, border-color 0.15s;
        }
        .color-swatch:hover {
            transform: scale(1.15);
            border-color: rgba(79, 70, 229, 0.5);
        }
    </style>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#7c3aed',
                    }
                }
            }
        }
    </script>
</head>
<body class="text-slate-800 dark:text-slate-100 h-screen flex flex-col overflow-hidden selection:bg-indigo-500 selection:text-white">

    <!-- PERSISTENT HEADER -->
    <header id="app-header" class="glass flex items-center justify-between px-4 md:px-6 z-40 shrink-0">
        <!-- Left: Logo -->
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center shadow-md shadow-indigo-500/30">
                <i data-lucide="layout-grid" class="text-white w-4 h-4"></i>
            </div>
            <div class="hidden sm:block">
                <span class="font-black text-base tracking-tight">WebDesks</span>
                <span class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest ml-2">v0.16</span>
            </div>
        </div>

        <!-- Center: Live Clock -->
        <div class="text-center">
            <div id="header-time" class="text-xl md:text-2xl font-black timer-font text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 leading-none">--:--:--</div>
            <div id="header-date" class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mt-0.5 hidden md:block">Loading...</div>
        </div>

        <!-- Right: Actions -->
        <div class="flex items-center gap-1.5">
            <!-- Alarm bell indicator -->
            <button onclick="app.switchTab('clock')" id="header-alarm-btn" class="p-2 rounded-xl glass hover:bg-indigo-500 hover:text-white transition-all" title="Alarm">
                <i data-lucide="bell-off" id="header-bell-icon" class="w-4 h-4"></i>
            </button>
            <button onclick="app.toggleTheme()" class="p-2 rounded-xl glass hover:bg-indigo-500 hover:text-white transition-all" title="Toggle Theme">
                <i data-lucide="moon" class="w-4 h-4 dark:hidden"></i>
                <i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i>
            </button>
            <button onclick="app.toggleZenMode()" class="p-2 rounded-xl glass hover:bg-indigo-500 hover:text-white transition-all hidden sm:flex items-center justify-center" title="Zen Mode (Alt+Z)">
                <i data-lucide="maximize-2" class="w-4 h-4"></i>
            </button>
            <button onclick="app.togglePrivacy()" class="p-2 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center" title="Privacy Mode (Alt+P)">
                <i data-lucide="shield-alert" class="w-4 h-4"></i>
            </button>
        </div>
    </header>

    <!-- APP BODY (sidebar + main) -->
    <div id="app-body" class="flex flex-col md:flex-row overflow-hidden min-h-0">

    <!-- SIDEBAR -->
    <aside class="order-last md:order-first w-full md:w-20 lg:w-64 glass md:m-3 rounded-none md:rounded-3xl flex md:flex-col shrink-0 z-50 transition-all duration-300 h-16 md:h-auto overflow-hidden border-t md:border-t-0 border-white/20">
        <!-- Navigation -->
        <nav class="flex-1 flex md:flex-col overflow-x-auto md:overflow-y-auto p-2 md:p-3 space-x-1 md:space-x-0 md:space-y-1 no-scrollbar items-center md:items-stretch">
            <div class="hidden lg:block text-[10px] font-bold text-slate-400 uppercase px-3 py-2 mt-2 tracking-widest">Workspace</div>
            
            <button onclick="app.switchTab('dashboard')" class="nav-btn active flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="dashboard">
                <i data-lucide="home" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Dashboard</span>
            </button>
            
            <button onclick="app.switchTab('scratchpad')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="scratchpad">
                <i data-lucide="file-text" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Scratchpad</span>
            </button>
            
            <button onclick="app.switchTab('tasks')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="tasks">
                <i data-lucide="check-circle-2" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Tasks</span>
            </button>
            
            <button onclick="app.switchTab('board')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="board">
                <i data-lucide="columns" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Project Board</span>
            </button>
            
            <button onclick="app.switchTab('whiteboard')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="whiteboard">
                <i data-lucide="pencil" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Whiteboard</span>
            </button>

            <div class="hidden lg:block text-[10px] font-bold text-slate-400 uppercase px-3 py-2 mt-4 tracking-widest">Focus</div>
            
            <button onclick="app.switchTab('clock')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="clock">
                <i data-lucide="clock" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Desk Clock</span>
            </button>
            
            <button onclick="app.switchTab('timer')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="timer">
                <i data-lucide="hourglass" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Focus Timer</span>
            </button>

            <button onclick="app.switchTab('stopwatch')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="stopwatch">
                <i data-lucide="timer" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Stopwatch</span>
            </button>

            <button onclick="app.switchTab('focustown')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="focustown">
                <i data-lucide="building-2" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Focus Town</span>
            </button>

            <button onclick="app.switchTab('audio')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="audio">
                <i data-lucide="headphones" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Sound Studio</span>
            </button>
            
            <button onclick="app.switchTab('breathing')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="breathing">
                <i data-lucide="wind" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Breathing</span>
            </button>

            <div class="hidden lg:block text-[10px] font-bold text-slate-400 uppercase px-3 py-2 mt-4 tracking-widest">Tools</div>
            
            <button onclick="app.switchTab('calculator')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="calculator">
                <i data-lucide="calculator" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Calculator</span>
            </button>

            <button onclick="app.switchTab('converter')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="converter">
                <i data-lucide="arrow-left-right" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Converter</span>
            </button>

            <button onclick="app.switchTab('colorpicker')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="colorpicker">
                <i data-lucide="palette" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Colors</span>
            </button>

            <button onclick="app.switchTab('pdf')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="pdf">
                <i data-lucide="file-stack" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">PDF Merger</span>
            </button>
            
            <button onclick="app.switchTab('zones')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="zones">
                <i data-lucide="globe-2" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Time Zones</span>
            </button>
            
            <button onclick="app.switchTab('onair')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="onair">
                <i data-lucide="radio" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">On Air</span>
            </button>
            
            <button onclick="app.switchTab('recorder')" class="nav-btn flex-shrink-0 w-12 md:w-full flex items-center justify-center md:justify-start p-3 rounded-xl transition-all hover:bg-white/40 dark:hover:bg-slate-800/50 group" data-tab="recorder">
                <i data-lucide="video" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="hidden lg:block ml-3 font-medium text-sm">Recorder</span>
            </button>
        </nav>

        <!-- Music Player -->
        <div class="hidden md:flex flex-col px-4 pt-2 pb-2 border-t border-slate-200/50 dark:border-slate-800/50">
            <div class="glass p-3 rounded-xl flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-indigo-500 flex items-center justify-center shrink-0 shadow-lg shadow-indigo-500/20 relative overflow-hidden">
                    <i data-lucide="music" id="music-icon" class="w-5 h-5 text-white relative z-10 transition-opacity duration-300"></i>
                    <canvas id="music-viz" width="40" height="40" class="absolute inset-0 opacity-0 transition-opacity duration-300"></canvas>
                </div>
                <div class="overflow-hidden flex-1 min-w-0 hidden lg:block">
                    <div class="text-xs font-bold truncate">Lo-Fi Radio</div>
                    <div class="text-[10px] text-slate-400 truncate">Focus Beats</div>
                </div>
                <button onclick="app.toggleMusic()" id="sidebar-play-btn" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 flex items-center justify-center transition-colors shrink-0 mx-auto lg:mx-0">
                    <i data-lucide="play" class="w-4 h-4 fill-current"></i>
                </button>
            </div>
        </div>

    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 relative overflow-hidden order-first md:order-last">
        <button onclick="app.toggleZenMode()" id="exit-zen-btn" class="absolute top-6 right-6 z-50 p-3 rounded-xl glass hover:bg-indigo-500 hover:text-white transition-all hidden shadow-lg" title="Exit Zen Mode (Alt+Z)">
            <i data-lucide="minimize-2" class="w-5 h-5"></i>
        </button>
        
        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="max-w-6xl mx-auto space-y-6 h-full overflow-y-auto pb-20">
                <!-- Search Bar -->
                <div class="glass p-2 rounded-[1.5rem] relative z-30">
                    <div class="flex items-center px-4 py-2">
                        <i data-lucide="search" class="w-5 h-5 text-slate-400 mr-3"></i>
                        <input type="text" id="dash-search" placeholder="Search tools (Press '/' to focus)..." 
                            class="bg-transparent border-none w-full text-lg font-medium focus:ring-0 placeholder:text-slate-400 text-slate-800 dark:text-slate-100"
                            oninput="app.handleSearch(this.value)">
                        <div class="hidden md:flex text-[10px] font-bold text-slate-400 border border-slate-300 dark:border-slate-600 rounded px-1.5 py-0.5">/</div>
                    </div>
                    <div id="search-results" class="hidden border-t border-slate-200 dark:border-slate-700/50 p-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                </div>

                <!-- Hero: Focus Input -->
                <div class="glass p-8 md:p-10 rounded-2xl relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 pointer-events-none"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest" id="greeting">Good Morning</span>
                        </div>
                        <input type="text" id="daily-focus" placeholder="What's your main focus today?"
                            class="bg-transparent border-none p-0 text-2xl md:text-3xl font-bold text-slate-800 dark:text-slate-100 placeholder:text-slate-400 focus:ring-0 w-full transition-all">
                    </div>
                </div>

                <!-- Stats + Weather Row -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Alarm -->
                    <div class="glass p-5 rounded-2xl flex flex-col items-center justify-center gap-2 cursor-pointer hover:border-orange-300 border border-transparent transition-colors" onclick="app.switchTab('clock')">
                        <div class="text-[10px] font-black uppercase tracking-widest text-orange-500">Next Alarm</div>
                        <div id="dash-alarm-status" class="text-2xl font-black timer-font">--:--</div>
                        <div class="text-[10px] text-slate-400 uppercase font-medium">Set Alarm ‚Üí</div>
                    </div>

                    <!-- Focus Timer -->
                    <div class="glass p-5 rounded-2xl flex flex-col items-center justify-center gap-2 cursor-pointer hover:border-indigo-300 border border-transparent transition-colors" onclick="app.switchTab('timer')">
                        <div class="text-[10px] font-black uppercase tracking-widest text-indigo-500">Focus Timer</div>
                        <div id="mini-timer" class="text-2xl font-black timer-font text-indigo-600">25:00</div>
                        <div class="text-[10px] text-slate-400 uppercase font-medium">Pomodoro</div>
                    </div>

                    <!-- Note Preview -->
                    <div class="glass p-5 rounded-2xl flex flex-col justify-between cursor-pointer hover:border-slate-300 border border-transparent transition-colors" onclick="app.switchTab('scratchpad')">
                        <div class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Latest Note</div>
                        <div id="dash-note-preview" class="text-sm text-slate-600 dark:text-slate-300 line-clamp-3 italic leading-relaxed">Start writing...</div>
                        <div class="text-[10px] text-indigo-500 font-bold mt-2 flex items-center gap-1">Open Editor <i data-lucide="arrow-right" class="w-3 h-3"></i></div>
                    </div>

                    <!-- Weather -->
                    <div class="glass p-5 rounded-2xl flex flex-col items-center justify-center text-center">
                        <div id="weather-icon" class="mb-2">
                            <i data-lucide="cloud-sun" class="w-10 h-10 text-orange-500"></i>
                        </div>
                        <div id="weather-temp" class="text-2xl font-black cursor-pointer" onclick="app.toggleWeatherUnit()" title="Click to toggle ¬∞C/¬∞F">--¬∞F</div>
                        <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mt-1">Weather</p>
                    </div>
                </div>

                <!-- Hydration -->
                <div class="glass p-5 rounded-2xl flex items-center gap-6">
                    <div class="text-[10px] font-black uppercase tracking-widest text-blue-500 shrink-0">Hydration</div>
                    <div class="flex gap-1.5 flex-1" id="water-grid"></div>
                    <button onclick="app.addWater()" class="text-[10px] bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl font-bold transition-colors shadow-lg shadow-blue-500/30 shrink-0">+ Glass</button>
                </div>

                <!-- Daily Quote -->
                <div class="glass p-4 rounded-2xl flex items-start gap-3 relative overflow-hidden">
                    <i data-lucide="quote" class="w-5 h-5 text-slate-300 dark:text-slate-600 shrink-0 mt-0.5"></i>
                    <div class="flex-1 min-w-0">
                        <p id="daily-quote" class="text-sm font-medium text-slate-600 dark:text-slate-300 italic leading-relaxed">"Loading inspiration..."</p>
                        <p id="quote-author" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1">- WebDesks</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-black uppercase tracking-widest text-slate-400">Quick Actions</h3>
                        <button onclick="app.openPinManager()" class="text-xs font-bold text-indigo-500 hover:text-indigo-600 transition-colors flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-3 h-3"></i> Customize
                        </button>
                    </div>
                    <div id="quick-actions-grid" class="flex flex-wrap gap-3 min-h-[40px]"></div>
                    <p class="text-[10px] text-slate-400 mt-3 italic opacity-50">Double-click a pin to edit or remove.</p>
                </div>
            </div>
        </div>

        <!-- SCRATCHPAD -->
        <div id="scratchpad" class="tab-content">
            <div class="h-full flex flex-col gap-4 max-w-5xl mx-auto">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-black">Scratchpad</h2>
                        <p class="text-sm text-slate-400">Auto-saved locally. Never leaves your device.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="app.copyNote()" class="glass px-4 py-2 rounded-xl text-xs font-bold uppercase hover:bg-indigo-500 hover:text-white transition-all flex items-center gap-2">
                            <i data-lucide="copy" class="w-4 h-4"></i> Copy
                        </button>
                        <button onclick="app.downloadNote()" class="glass px-4 py-2 rounded-xl text-xs font-bold uppercase hover:bg-indigo-500 hover:text-white transition-all flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> Download
                        </button>
                    </div>
                </div>
                <div class="flex-1 glass rounded-[2rem] overflow-hidden shadow-inner relative group">
                    <textarea id="note-area" class="w-full h-full bg-transparent p-8 md:p-12 text-lg md:text-xl focus:outline-none resize-none leading-relaxed font-light" placeholder="Start typing your thoughts..."></textarea>
                    <div class="absolute bottom-4 right-4 text-xs text-slate-400 font-mono opacity-0 group-hover:opacity-100 transition-opacity" id="word-count">0 words</div>
                </div>
            </div>
        </div>

        <!-- TASKS -->
        <div id="tasks" class="tab-content">
            <div class="max-w-3xl mx-auto py-6 h-full flex flex-col">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-black">Task Manager</h2>
                    <div class="text-sm text-slate-400" id="task-stats">0 tasks</div>
                </div>
                
                <div class="glass p-2 rounded-2xl flex gap-2 mb-6 shadow-xl">
                    <input type="text" id="task-input" placeholder="What needs to be done?" class="flex-1 bg-transparent px-6 py-4 focus:outline-none text-lg" onkeypress="if(event.key==='Enter') app.addTask()">
                    <input type="time" id="task-time" class="bg-transparent border-l border-slate-300 dark:border-slate-700 px-4 text-sm text-slate-500 focus:outline-none hidden md:block">
                    <button onclick="app.addTask()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-xl font-bold transition-colors flex items-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span class="hidden md:inline">Add</span>
                    </button>
                </div>

                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onclick="app.filterTasks('all')" class="filter-btn active px-4 py-2 rounded-full text-xs font-bold uppercase bg-indigo-600 text-white" data-filter="all">All</button>
                    <button onclick="app.filterTasks('active')" class="filter-btn px-4 py-2 rounded-full text-xs font-bold uppercase glass hover:bg-white/50" data-filter="active">Active</button>
                    <button onclick="app.filterTasks('completed')" class="filter-btn px-4 py-2 rounded-full text-xs font-bold uppercase glass hover:bg-white/50" data-filter="completed">Completed</button>
                </div>

                <div class="flex-1 overflow-y-auto space-y-3 pr-2" id="task-list">
                    <div class="text-center text-slate-400 py-12">
                        <i data-lucide="check-circle-2" class="w-12 h-12 mx-auto mb-4 opacity-30"></i>
                        <p>No tasks yet. Add one above!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- KANBAN BOARD -->
        <div id="board" class="tab-content">
            <div class="h-full flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-black">Project Board</h2>
                    <button onclick="app.clearBoard()" class="text-xs text-red-500 font-bold uppercase hover:text-red-600">Clear All</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-[calc(100%-4rem)] overflow-y-auto pb-20">
                    <!-- Todo -->
                    <div class="flex flex-col h-full min-h-[300px]">
                        <div class="flex justify-between items-center px-2 mb-3">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                                <span class="text-xs font-black uppercase tracking-widest text-slate-400">To Do</span>
                                <span class="text-[10px] bg-slate-200 dark:bg-slate-700 px-2 py-0.5 rounded-full" id="count-todo">0</span>
                            </div>
                            <button onclick="app.addBoardItem('todo')" class="p-2 glass rounded-lg hover:bg-indigo-500 hover:text-white transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="kb-todo" class="flex-1 glass rounded-2xl p-3 space-y-3 overflow-y-auto transition-colors" ondrop="app.drop(event, 'todo')" ondragover="app.allowDrop(event)"></div>
                    </div>

                    <!-- In Progress -->
                    <div class="flex flex-col h-full min-h-[300px]">
                        <div class="flex justify-between items-center px-2 mb-3">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                                <span class="text-xs font-black uppercase tracking-widest text-indigo-500">In Progress</span>
                                <span class="text-[10px] bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 px-2 py-0.5 rounded-full" id="count-doing">0</span>
                            </div>
                        </div>
                        <div id="kb-doing" class="flex-1 glass rounded-2xl p-3 space-y-3 overflow-y-auto transition-colors" ondrop="app.drop(event, 'doing')" ondragover="app.allowDrop(event)"></div>
                    </div>

                    <!-- Done -->
                    <div class="flex flex-col h-full min-h-[300px]">
                        <div class="flex justify-between items-center px-2 mb-3">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                <span class="text-xs font-black uppercase tracking-widest text-green-500">Done</span>
                                <span class="text-[10px] bg-green-100 dark:bg-green-900/30 text-green-600 px-2 py-0.5 rounded-full" id="count-done">0</span>
                            </div>
                        </div>
                        <div id="kb-done" class="flex-1 glass rounded-2xl p-3 space-y-3 overflow-y-auto transition-colors" ondrop="app.drop(event, 'done')" ondragover="app.allowDrop(event)"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WHITEBOARD -->
        <div id="whiteboard" class="tab-content">
            <div class="h-full flex flex-col gap-4">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <h2 class="text-2xl font-black">Whiteboard</h2>
                    <div class="glass p-2 rounded-xl flex items-center gap-3">
                        <div class="flex gap-1 border-r border-slate-300 dark:border-slate-700 pr-3">
                            <button onclick="app.setWBColor('#000000')" class="color-btn w-8 h-8 rounded-lg bg-black border-2 border-transparent hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-indigo-500" data-color="#000000"></button>
                            <button onclick="app.setWBColor('#ef4444')" class="color-btn w-8 h-8 rounded-lg bg-red-500 border-2 border-transparent hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-indigo-500" data-color="#ef4444"></button>
                            <button onclick="app.setWBColor('#22c55e')" class="color-btn w-8 h-8 rounded-lg bg-green-500 border-2 border-transparent hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-indigo-500" data-color="#22c55e"></button>
                            <button onclick="app.setWBColor('#3b82f6')" class="color-btn w-8 h-8 rounded-lg bg-blue-500 border-2 border-transparent hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-indigo-500" data-color="#3b82f6"></button>
                            <button onclick="app.setWBColor('#a855f7')" class="color-btn w-8 h-8 rounded-lg bg-purple-500 border-2 border-transparent hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-indigo-500" data-color="#a855f7"></button>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="app.setLineWidth(2)" class="px-3 py-1 rounded text-xs font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300">Thin</button>
                            <button onclick="app.setLineWidth(5)" class="px-3 py-1 rounded text-xs font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300">Med</button>
                            <button onclick="app.setLineWidth(10)" class="px-3 py-1 rounded text-xs font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300">Thick</button>
                        </div>
                        <div class="flex gap-1 border-l border-slate-300 dark:border-slate-700 pl-3">
                            <button onclick="app.undoWB()" class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700" title="Undo">
                                <i data-lucide="undo-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="app.clearWB()" class="p-2 rounded-lg hover:bg-red-100 text-red-500" title="Clear">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="app.downloadWB()" class="p-2 rounded-lg hover:bg-indigo-100 text-indigo-500" title="Download">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex-1 glass rounded-[2rem] overflow-hidden relative shadow-inner bg-white dark:bg-slate-900">
                    <canvas id="wb-canvas" class="w-full h-full block"></canvas>
                    <div class="absolute bottom-4 left-4 text-xs text-slate-400 font-mono pointer-events-none">Drawing Mode</div>
                </div>
            </div>
        </div>

        <!-- DESK CLOCK -->
        <div id="clock" class="tab-content flex flex-col items-center justify-center">
            <div class="text-center mb-12 group cursor-default">
                <div id="full-clock" class="text-[12vw] md:text-[15vw] font-black leading-none tracking-tighter timer-font bg-clip-text text-transparent bg-gradient-to-b from-slate-800 to-slate-600 dark:from-slate-100 dark:to-slate-400 select-none">
                    00:00
                </div>
                <div id="full-date" class="text-lg md:text-2xl font-medium uppercase tracking-[0.3em] text-slate-400 mt-6">Monday, January 1</div>
            </div>

            <div class="glass p-6 md:p-8 rounded-[2rem] flex flex-col md:flex-row items-center gap-6 w-full max-w-2xl mx-4">
                <div class="flex-1 w-full">
                    <label class="text-[10px] font-black uppercase text-slate-400 mb-2 block">Set Alarm</label>
                    <input type="time" id="alarm-input" class="w-full bg-transparent text-3xl md:text-4xl font-bold focus:outline-none text-center md:text-left timer-font border-b-2 border-transparent focus:border-indigo-500 transition-colors pb-2">
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <button onclick="app.setAlarm()" id="alarm-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all hover:scale-105">Set Alarm</button>
                    <button onclick="app.clearAlarm()" class="p-4 rounded-xl glass text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <div class="mt-8 flex gap-4 text-sm text-slate-400">
                <div class="flex items-center gap-2">
                    <i data-lucide="bell" class="w-4 h-4"></i>
                    <span>Alarm will ring for 1 minute</span>
                </div>
            </div>
        </div>

        <!-- FOCUS TIMER -->
        <div id="timer" class="tab-content flex flex-col items-center justify-center">
            <div class="glass p-8 md:p-16 rounded-[3rem] text-center max-w-md w-full relative overflow-hidden shadow-2xl">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500"></div>
                
                <div class="mb-8">
                    <div class="inline-flex gap-2 p-1 rounded-full glass mb-6">
                        <button onclick="app.setTimerMode(25)" class="timer-mode-btn px-4 py-2 rounded-full text-xs font-bold transition-all bg-indigo-600 text-white" data-time="25">25m</button>
                        <button onclick="app.setTimerMode(45)" class="timer-mode-btn px-4 py-2 rounded-full text-xs font-bold transition-all hover:bg-white/20" data-time="45">45m</button>
                        <button onclick="app.setTimerMode(60)" class="timer-mode-btn px-4 py-2 rounded-full text-xs font-bold transition-all hover:bg-white/20" data-time="60">60m</button>
                    </div>
                    
                    <div id="timer-display" class="text-7xl md:text-8xl font-black mb-2 timer-font text-slate-800 dark:text-slate-100">25:00</div>
                    <p class="text-xs font-black uppercase tracking-[0.3em] text-indigo-500" id="timer-status">Ready to Focus</p>
                </div>

                <div class="flex gap-4">
                    <button id="timer-btn" onclick="app.toggleTimer()" class="flex-1 btn-primary text-white py-5 rounded-2xl font-bold text-lg">
                        Start Focus
                    </button>
                    <button onclick="app.resetTimer()" class="glass w-16 rounded-2xl flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                        <i data-lucide="rotate-ccw" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700/50 flex justify-center gap-8 text-xs text-slate-400">
                    <div class="text-center">
                        <div class="font-bold text-slate-600 dark:text-slate-300" id="session-count">0</div>
                        <div class="uppercase tracking-wider mt-1">Sessions</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-slate-600 dark:text-slate-300" id="total-focus">0m</div>
                        <div class="uppercase tracking-wider mt-1">Total</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STOPWATCH -->
        <div id="stopwatch" class="tab-content flex flex-col items-center justify-center p-4">
            <div class="max-w-md w-full glass p-8 md:p-12 rounded-[3rem] text-center space-y-8 relative overflow-hidden shadow-2xl">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 via-teal-500 to-green-500"></div>

                <div>
                    <div id="sw-display" class="text-6xl md:text-7xl font-black timer-font tracking-tighter text-slate-800 dark:text-slate-100">00:00.00</div>
                    <p class="text-xs font-black uppercase tracking-[0.3em] text-green-500 mt-2" id="sw-status">Ready</p>
                </div>

                <div class="flex gap-3 justify-center">
                    <button id="sw-btn" onclick="app.toggleStopwatch()" class="flex-1 btn-primary text-white py-4 rounded-2xl font-bold text-lg">Start</button>
                    <button onclick="app.lapStopwatch()" id="sw-lap-btn" class="glass px-5 rounded-2xl font-bold text-sm hover:bg-white/80 dark:hover:bg-slate-800 transition-colors" disabled>Lap</button>
                    <button onclick="app.resetStopwatch()" class="glass w-14 rounded-2xl flex items-center justify-center hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 transition-colors">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                    </button>
                </div>

                <div id="sw-laps" class="text-left space-y-2 max-h-48 overflow-y-auto hidden"></div>
            </div>
        </div>

        <!-- SOUND STUDIO -->
        <div id="audio" class="tab-content flex items-center justify-center">
            <div class="max-w-3xl w-full glass p-8 md:p-12 rounded-[3rem] text-center space-y-8">
                <div>
                    <h2 class="text-3xl font-black mb-2">Sound Studio</h2>
                    <p class="text-slate-400 text-sm">Generate ambient noise to help you focus</p>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="app.toggleNoise('white')" id="noise-white" class="noise-btn p-6 rounded-3xl border-2 border-transparent glass hover:border-indigo-500 transition-all flex flex-col items-center gap-3 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-indigo-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <i data-lucide="wind" class="w-8 h-8 text-slate-400 group-hover:text-indigo-500 transition-colors"></i>
                        <span class="text-xs font-black uppercase">White Noise</span>
                        <div class="playing-indicator hidden absolute top-2 right-2 w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div>
                    </button>

                    <button onclick="app.toggleNoise('pink')" id="noise-pink" class="noise-btn p-6 rounded-3xl border-2 border-transparent glass hover:border-pink-500 transition-all flex flex-col items-center gap-3 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-pink-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <i data-lucide="cloud-rain" class="w-8 h-8 text-slate-400 group-hover:text-pink-500 transition-colors"></i>
                        <span class="text-xs font-black uppercase">Pink Noise</span>
                        <div class="playing-indicator hidden absolute top-2 right-2 w-2 h-2 bg-pink-500 rounded-full animate-pulse"></div>
                    </button>

                    <button onclick="app.toggleNoise('brown')" id="noise-brown" class="noise-btn p-6 rounded-3xl border-2 border-transparent glass hover:border-amber-700 transition-all flex flex-col items-center gap-3 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-amber-700/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <i data-lucide="waves" class="w-8 h-8 text-slate-400 group-hover:text-amber-700 transition-colors"></i>
                        <span class="text-xs font-black uppercase">Brown Noise</span>
                        <div class="playing-indicator hidden absolute top-2 right-2 w-2 h-2 bg-amber-700 rounded-full animate-pulse"></div>
                    </button>

                    <button onclick="app.toggleNoise('nature')" id="noise-nature" class="noise-btn p-6 rounded-3xl border-2 border-transparent glass hover:border-green-500 transition-all flex flex-col items-center gap-3 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-green-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <i data-lucide="trees" class="w-8 h-8 text-slate-400 group-hover:text-green-500 transition-colors"></i>
                        <span class="text-xs font-black uppercase">Nature</span>
                        <div class="playing-indicator hidden absolute top-2 right-2 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </button>
                </div>

                <div class="glass p-4 rounded-2xl flex items-center gap-4">
                    <i data-lucide="volume-2" class="w-5 h-5 text-slate-400"></i>
                    <input type="range" min="0" max="1" step="0.01" value="0.3" oninput="app.setVolume(this.value)" class="flex-1 accent-indigo-500 h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    <span class="text-xs font-mono w-8 text-right" id="vol-display">30%</span>
                </div>
            </div>
        </div>

        <!-- BREATHING GUIDE -->
        <div id="breathing" class="tab-content flex flex-col items-center justify-center">
            <div class="max-w-md w-full glass p-8 md:p-12 rounded-[3rem] text-center space-y-8 relative overflow-hidden">
                <button onclick="app.toggleBreathMute()" id="breath-mute-btn" class="absolute top-6 right-6 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-slate-400 hover:text-indigo-500" title="Toggle Sound">
                    <i data-lucide="volume-2" class="w-5 h-5"></i>
                </button>
                <!-- Visualizer -->
                <div class="relative w-64 h-64 mx-auto flex items-center justify-center my-8">
                    <div id="breath-circle" class="absolute inset-0 bg-indigo-500/20 rounded-full scale-50 transition-transform ease-in-out"></div>
                    <div id="breath-circle-inner" class="absolute w-48 h-48 bg-indigo-500/30 rounded-full scale-50 transition-transform ease-in-out blur-xl"></div>
                    <div class="relative z-10">
                        <div id="breath-instruction" class="text-3xl font-black text-indigo-600 dark:text-indigo-400 uppercase tracking-widest">Ready</div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="space-y-6">
                    <div class="flex justify-center gap-2 flex-wrap">
                        <button onclick="app.setBreathTechnique('box')" class="breath-btn active px-4 py-2 rounded-full text-xs font-bold bg-indigo-600 text-white transition-all" data-tech="box">Box (4-4-4-4)</button>
                        <button onclick="app.setBreathTechnique('478')" class="breath-btn px-4 py-2 rounded-full text-xs font-bold glass hover:bg-white/50 transition-all" data-tech="478">Relax (4-7-8)</button>
                        <button onclick="app.setBreathTechnique('coherence')" class="breath-btn px-4 py-2 rounded-full text-xs font-bold glass hover:bg-white/50 transition-all" data-tech="coherence">Coherence (6-6)</button>
                    </div>
                    
                    <button onclick="app.toggleBreathing()" id="breath-toggle" class="w-full btn-primary text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-indigo-500/30">Start Breathing</button>
                    <p id="breath-desc" class="text-xs text-slate-400 max-w-xs mx-auto">Equal breathing for focus and stress reduction.</p>
                </div>
            </div>
        </div>

        <!-- CALCULATOR -->
        <div id="calculator" class="tab-content flex flex-col items-center justify-center p-4">
            <div class="max-w-sm w-full glass p-6 rounded-[2rem] shadow-2xl">
                <!-- Display -->
                <div class="bg-slate-100 dark:bg-slate-800 p-6 rounded-2xl mb-6 text-right relative overflow-hidden">
                    <div id="calc-history" class="text-xs text-slate-400 font-mono h-4 mb-1"></div>
                    <div id="calc-display" class="text-4xl font-black timer-font tracking-tight truncate">0</div>
                </div>
                
                <!-- Keypad -->
                <div class="grid grid-cols-4 gap-3">
                    <button onclick="app.calcClear()" class="p-4 rounded-xl bg-red-100 text-red-600 font-bold hover:bg-red-200 transition-colors">AC</button>
                    <button onclick="app.calcDelete()" class="p-4 rounded-xl bg-slate-200 dark:bg-slate-700 font-bold hover:bg-slate-300 transition-colors"><i data-lucide="delete" class="w-5 h-5 mx-auto"></i></button>
                    <button onclick="app.calcAppend('%')" class="p-4 rounded-xl bg-slate-200 dark:bg-slate-700 font-bold hover:bg-slate-300 transition-colors">%</button>
                    <button onclick="app.calcAppend('/')" class="p-4 rounded-xl bg-indigo-100 text-indigo-600 font-bold hover:bg-indigo-200 transition-colors">√∑</button>
                    
                    <button onclick="app.calcAppend('7')" class="p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">7</button>
                    <button onclick="app.calcAppend('8')" class="p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">8</button>
                    <button onclick="app.calcAppend('9')" class="p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">9</button>
                    <button onclick="app.calcAppend('*')" class="p-4 rounded-xl bg-indigo-100 text-indigo-600 font-bold hover:bg-indigo-200 transition-colors">√ó</button>
                    
                    <button onclick="app.calcAppend('4')" class="p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">4</button>
                    <button onclick="app.calcAppend('5')" class="p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">5</button>
                    <button onclick="app.calcAppend('6')" class="p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">6</button>
                    <button onclick="app.calcAppend('-')" class="p-4 rounded-xl bg-indigo-100 text-indigo-600 font-bold hover:bg-indigo-200 transition-colors">-</button>
                    
                    <button onclick="app.calcAppend('1')" class="p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">1</button>
                    <button onclick="app.calcAppend('2')" class="p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">2</button>
                    <button onclick="app.calcAppend('3')" class="p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">3</button>
                    <button onclick="app.calcAppend('+')" class="p-4 rounded-xl bg-indigo-100 text-indigo-600 font-bold hover:bg-indigo-200 transition-colors">+</button>
                    
                    <button onclick="app.calcAppend('0')" class="col-span-2 p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">0</button>
                    <button onclick="app.calcAppend('.')" class="p-4 rounded-xl glass hover:bg-white/50 font-bold text-xl">.</button>
                    <button onclick="app.calcResult()" class="p-4 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/30">=</button>
                </div>
            </div>
        </div>

        <!-- PDF MERGER -->
        <div id="pdf" class="tab-content flex flex-col items-center justify-center p-4">
            <div class="max-w-xl w-full glass p-8 md:p-12 rounded-[3rem] text-center space-y-6">
                <div class="w-20 h-20 bg-gradient-to-br from-red-400 to-red-600 rounded-full flex items-center justify-center mx-auto shadow-lg shadow-red-500/30">
                    <i data-lucide="file-stack" class="w-10 h-10 text-white"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-black mb-2">PDF Merger</h2>
                    <p class="text-slate-400 text-sm">Combine PDFs entirely in-browser. Your files never leave your device.</p>
                </div>

                <div id="pdf-drop-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 p-10 rounded-3xl hover:border-indigo-500 hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20 transition-all cursor-pointer relative group" onclick="document.getElementById('pdf-input').click()">
                    <input type="file" id="pdf-input" multiple accept=".pdf" class="hidden" onchange="app.handlePDFs(this)">
                    <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto mb-4 text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                    <p class="text-sm font-bold text-slate-600 dark:text-slate-300">Drop PDFs here or click to browse</p>
                    <p class="text-xs text-slate-400 mt-2">Select multiple files to merge in order</p>
                </div>

                <div id="pdf-list" class="text-left space-y-2 max-h-40 overflow-y-auto hidden"></div>

                <div id="pdf-actions" class="hidden space-y-3">
                    <button id="pdf-merge-btn" onclick="app.mergePDFs()" class="w-full btn-primary text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2">
                        <i data-lucide="combine" class="w-5 h-5"></i>
                        Merge & Download
                    </button>
                    <button onclick="app.clearPDFs()" class="w-full glass py-3 rounded-2xl font-bold text-sm text-slate-500 hover:text-red-500 transition-colors">
                        Clear Files
                    </button>
                </div>
            </div>
        </div>

        <!-- TIME ZONES -->
        <div id="zones" class="tab-content flex flex-col items-center justify-center p-4">
            <div class="max-w-4xl w-full glass p-8 md:p-10 rounded-[3rem] space-y-8">
                <div class="text-center">
                    <h2 class="text-3xl font-black mb-2">Global Meeting Planner</h2>
                    <p class="text-slate-400 text-sm">Drag the slider to find the perfect meeting time across time zones</p>
                </div>

                <div class="relative py-6">
                    <input type="range" min="0" max="23" value="12" id="zone-slider" oninput="app.updateZones(this.value)" 
                        class="w-full h-3 bg-slate-200 dark:bg-slate-700 rounded-full appearance-none cursor-pointer accent-indigo-600 relative z-10">
                    <div class="flex justify-between text-[10px] font-bold text-slate-400 mt-4 uppercase tracking-wider">
                        <span>12 AM</span><span>6 AM</span><span>12 PM</span><span>6 PM</span><span>12 AM</span>
                    </div>
                </div>

                <div class="flex justify-center gap-4 flex-wrap mb-6">
                    <button onclick="app.setZoneTime('now')" class="px-4 py-2 rounded-full glass text-xs font-bold hover:bg-indigo-500 hover:text-white transition-colors">Now</button>
                    <button onclick="app.setZoneTime('morning')" class="px-4 py-2 rounded-full glass text-xs font-bold hover:bg-indigo-500 hover:text-white transition-colors">9 AM</button>
                    <button onclick="app.setZoneTime('noon')" class="px-4 py-2 rounded-full glass text-xs font-bold hover:bg-indigo-500 hover:text-white transition-colors">12 PM</button>
                    <button onclick="app.setZoneTime('evening')" class="px-4 py-2 rounded-full glass text-xs font-bold hover:bg-indigo-500 hover:text-white transition-colors">6 PM</button>
                </div>

                <div id="zone-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>
        </div>

        <!-- ON AIR -->
        <div id="onair" class="tab-content">
            <div class="max-w-5xl mx-auto h-full flex flex-col items-center justify-center gap-8 p-4">
                <div class="text-center">
                    <h2 class="text-3xl font-black mb-2">Status Signal</h2>
                    <p class="text-slate-400">Click a card to display full-screen status</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
                    <div onclick="app.showOnAir('busy')" class="glass p-8 md:p-12 rounded-[2.5rem] text-center cursor-pointer hover:scale-105 transition-all group border-2 border-transparent hover:border-red-500/50">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                            <i data-lucide="video" class="w-8 h-8 text-red-600"></i>
                        </div>
                        <h3 class="text-2xl font-black text-red-600 mb-2">On Call</h3>
                        <p class="text-xs text-slate-400">Do not disturb</p>
                    </div>

                    <div onclick="app.showOnAir('focus')" class="glass p-8 md:p-12 rounded-[2.5rem] text-center cursor-pointer hover:scale-105 transition-all group border-2 border-transparent hover:border-indigo-500/50">
                        <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                            <i data-lucide="brain" class="w-8 h-8 text-indigo-600"></i>
                        </div>
                        <h3 class="text-2xl font-black text-indigo-600 mb-2">Deep Work</h3>
                        <p class="text-xs text-slate-400">Focus mode active</p>
                    </div>

                    <div onclick="app.showOnAir('free')" class="glass p-8 md:p-12 rounded-[2.5rem] text-center cursor-pointer hover:scale-105 transition-all group border-2 border-transparent hover:border-green-500/50">
                        <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                            <i data-lucide="coffee" class="w-8 h-8 text-green-600"></i>
                        </div>
                        <h3 class="text-2xl font-black text-green-600 mb-2">Available</h3>
                        <p class="text-xs text-slate-400">Free to chat</p>
                    </div>
                </div>

                <div class="glass p-6 rounded-2xl mt-8 max-w-md w-full">
                    <label class="text-xs font-bold uppercase text-slate-400 mb-2 block">Custom Message</label>
                    <input type="text" id="custom-status" placeholder="Enter custom status..." class="w-full bg-transparent border-b border-slate-300 dark:border-slate-600 py-2 focus:outline-none focus:border-indigo-500 transition-colors">
                </div>
            </div>
        </div>

        <!-- UNIT CONVERTER -->
        <div id="converter" class="tab-content flex flex-col items-center justify-center p-4">
            <div class="max-w-xl w-full glass p-8 md:p-10 rounded-[3rem] space-y-6 shadow-2xl">
                <div class="text-center">
                    <h2 class="text-2xl font-black mb-1">Unit Converter</h2>
                    <p class="text-sm text-slate-400">Instant conversions, no install required</p>
                </div>

                <!-- Category tabs -->
                <div class="flex gap-2 flex-wrap justify-center">
                    <button onclick="app.switchConverterCategory('length')" class="conv-cat-btn px-4 py-2 rounded-full text-xs font-bold bg-indigo-600 text-white transition-all" data-cat="length">Length</button>
                    <button onclick="app.switchConverterCategory('weight')" class="conv-cat-btn px-4 py-2 rounded-full text-xs font-bold glass hover:bg-white/50 transition-all" data-cat="weight">Weight</button>
                    <button onclick="app.switchConverterCategory('temp')" class="conv-cat-btn px-4 py-2 rounded-full text-xs font-bold glass hover:bg-white/50 transition-all" data-cat="temp">Temp</button>
                    <button onclick="app.switchConverterCategory('volume')" class="conv-cat-btn px-4 py-2 rounded-full text-xs font-bold glass hover:bg-white/50 transition-all" data-cat="volume">Volume</button>
                    <button onclick="app.switchConverterCategory('speed')" class="conv-cat-btn px-4 py-2 rounded-full text-xs font-bold glass hover:bg-white/50 transition-all" data-cat="speed">Speed</button>
                </div>

                <!-- Converter fields -->
                <div class="flex items-center gap-3">
                    <div class="flex-1 space-y-2">
                        <select id="conv-from-unit" onchange="app.convertUnit()" class="w-full glass px-3 py-2 rounded-xl text-sm font-bold focus:outline-none dark:bg-slate-800/50"></select>
                        <input type="number" id="conv-from-val" oninput="app.convertUnit()" placeholder="Enter value" class="w-full glass px-4 py-3 rounded-xl text-xl font-bold focus:outline-none bg-transparent dark:bg-slate-800/30">
                    </div>
                    <button onclick="app.swapConverter()" class="p-3 rounded-full glass hover:bg-indigo-500 hover:text-white transition-all" title="Swap">
                        <i data-lucide="arrow-left-right" class="w-5 h-5"></i>
                    </button>
                    <div class="flex-1 space-y-2">
                        <select id="conv-to-unit" onchange="app.convertUnit()" class="w-full glass px-3 py-2 rounded-xl text-sm font-bold focus:outline-none dark:bg-slate-800/50"></select>
                        <input type="number" id="conv-to-val" oninput="app.convertUnitReverse()" placeholder="Result" class="w-full glass px-4 py-3 rounded-xl text-xl font-bold focus:outline-none bg-transparent dark:bg-slate-800/30">
                    </div>
                </div>

                <p id="conv-formula" class="text-center text-xs text-slate-400 italic"></p>
            </div>
        </div>

        <!-- COLOR PICKER -->
        <div id="colorpicker" class="tab-content flex flex-col items-center justify-center p-4">
            <div class="max-w-lg w-full glass p-8 rounded-[3rem] space-y-6 shadow-2xl">
                <div class="text-center">
                    <h2 class="text-2xl font-black mb-1">Color Picker</h2>
                    <p class="text-sm text-slate-400">Pick, copy, and save colors</p>
                </div>

                <!-- Picker row -->
                <div class="flex items-center gap-4">
                    <input type="color" id="cp-input" value="#4f46e5" oninput="app.updateColorFromPicker()" class="w-20 h-20 rounded-2xl border-0 cursor-pointer bg-transparent p-1">
                    <div id="cp-preview" class="flex-1 h-20 rounded-2xl shadow-inner" style="background:#4f46e5;"></div>
                </div>

                <!-- Format outputs -->
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-400 w-10">HEX</span>
                        <input type="text" id="cp-hex" value="#4f46e5" oninput="app.updateColorFromHex()" class="flex-1 glass px-3 py-2 rounded-xl text-sm font-mono focus:outline-none bg-transparent">
                        <button onclick="app.copyColorFormat('hex')" class="p-2 rounded-xl glass hover:bg-indigo-500 hover:text-white transition-all" title="Copy HEX"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-400 w-10">RGB</span>
                        <input type="text" id="cp-rgb" readonly class="flex-1 glass px-3 py-2 rounded-xl text-sm font-mono focus:outline-none bg-transparent">
                        <button onclick="app.copyColorFormat('rgb')" class="p-2 rounded-xl glass hover:bg-indigo-500 hover:text-white transition-all" title="Copy RGB"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-400 w-10">HSL</span>
                        <input type="text" id="cp-hsl" readonly class="flex-1 glass px-3 py-2 rounded-xl text-sm font-mono focus:outline-none bg-transparent">
                        <button onclick="app.copyColorFormat('hsl')" class="p-2 rounded-xl glass hover:bg-indigo-500 hover:text-white transition-all" title="Copy HSL"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <!-- RGB Sliders -->
                <div class="space-y-2">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold text-red-500 w-3">R</span>
                        <input type="range" id="cp-r" min="0" max="255" value="79" oninput="app.updateColorFromSliders()" class="flex-1 accent-red-500 h-2 rounded-lg appearance-none cursor-pointer">
                        <span id="cp-r-val" class="text-xs font-mono w-8 text-right">79</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold text-green-500 w-3">G</span>
                        <input type="range" id="cp-g" min="0" max="255" value="70" oninput="app.updateColorFromSliders()" class="flex-1 accent-green-500 h-2 rounded-lg appearance-none cursor-pointer">
                        <span id="cp-g-val" class="text-xs font-mono w-8 text-right">70</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold text-blue-500 w-3">B</span>
                        <input type="range" id="cp-b" min="0" max="255" value="229" oninput="app.updateColorFromSliders()" class="flex-1 accent-blue-500 h-2 rounded-lg appearance-none cursor-pointer">
                        <span id="cp-b-val" class="text-xs font-mono w-8 text-right">229</span>
                    </div>
                </div>

                <!-- Saved Swatches -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs font-black uppercase tracking-widest text-slate-400">Saved Swatches</span>
                        <button onclick="app.saveColorSwatch()" class="text-xs font-bold text-indigo-500 hover:text-indigo-600 transition-colors flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-3 h-3"></i> Save Current
                        </button>
                    </div>
                    <div id="cp-swatches" class="flex flex-wrap gap-2 min-h-[2.5rem]">
                        <span class="text-xs text-slate-400 italic">No saved swatches yet.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN RECORDER -->
        <div id="recorder" class="tab-content flex flex-col items-center justify-center p-4">
            <div class="max-w-md w-full glass p-8 md:p-12 rounded-[3rem] text-center space-y-6">
                <div id="rec-icon-container" class="w-24 h-24 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mx-auto transition-all duration-300">
                    <i data-lucide="video" id="rec-icon" class="w-12 h-12 text-indigo-600 transition-all duration-300"></i>
                </div>
                
                <div>
                    <h2 class="text-3xl font-black mb-2">Screen Recorder</h2>
                    <p class="text-slate-400 text-sm">Record your screen, window, or browser tab. No installation required.</p>
                </div>

                <div id="recording-info" class="hidden glass p-4 rounded-xl">
                    <div class="flex items-center justify-center gap-2 text-red-500 font-bold mb-2">
                        <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                        <span>RECORDING</span>
                    </div>
                    <div id="rec-timer" class="text-2xl font-mono font-bold">00:00:00</div>
                </div>

                <div class="space-y-3">
                    <button id="rec-btn" onclick="app.toggleRecording()" class="w-full btn-primary text-white py-4 rounded-2xl font-bold text-lg flex items-center justify-center gap-2">
                        <i data-lucide="circle" class="w-5 h-5 fill-current"></i>
                        <span id="rec-btn-text">Start Recording</span>
                    </button>
                    <p class="text-xs text-slate-400">Recording will download automatically when stopped</p>
                </div>
            </div>
        </div>

        <!-- FOCUS TOWN -->
        <div id="focustown" class="tab-content flex flex-col gap-4 overflow-y-auto">
            <!-- Header row -->
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <span id="ft-stage-emoji" class="text-2xl">üåæ</span>
                    <div>
                        <h2 class="text-2xl font-black leading-tight">Focus Town</h2>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span id="ft-stage-badge" class="text-[10px] font-black uppercase tracking-widest px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-600 dark:bg-indigo-900/40 dark:text-indigo-400">Village</span>
                            <span id="ft-total-chip" class="text-[10px] font-bold text-slate-400">0 min total</span>
                        </div>
                    </div>
                </div>
                <button onclick="app.ftResetProgress()" class="text-xs text-slate-400 hover:text-red-500 transition-colors font-medium px-3 py-1.5 rounded-lg glass" title="Reset all Focus Town progress">Reset Progress</button>
            </div>

            <!-- Town scene -->
            <div class="glass rounded-3xl overflow-hidden shadow-inner relative">
                <div id="ft-scene">
                    <!-- Rendered by ftRenderScene() -->
                </div>
                <!-- Stage unlock flash overlay -->
                <div id="ft-unlock-flash" class="absolute inset-0 rounded-3xl pointer-events-none opacity-0 transition-opacity duration-700 bg-yellow-300/20"></div>
            </div>

            <!-- Stage progress bar -->
            <div class="glass p-4 rounded-2xl">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-black uppercase tracking-widest text-slate-400">Progress</span>
                        <span id="ft-stage-name" class="text-xs font-bold text-indigo-500">Village</span>
                        <span class="text-xs text-slate-400">‚Üí</span>
                        <span id="ft-next-stage-name" class="text-xs font-bold text-slate-500">Hamlet</span>
                    </div>
                    <span id="ft-progress-label" class="text-xs text-slate-400 font-medium">30 min to unlock</span>
                </div>
                <div class="h-2.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                    <div id="ft-progress-bar" class="h-full rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-700" style="width:0%"></div>
                </div>
            </div>

            <!-- Timer card -->
            <div class="glass p-6 rounded-2xl flex flex-col gap-5">
                <!-- Mode selector -->
                <div class="flex justify-center">
                    <div class="inline-flex gap-2 p-1 rounded-full glass">
                        <button onclick="app.ftSetMode(25)" class="ft-mode-btn px-4 py-2 rounded-full text-xs font-bold transition-all bg-indigo-600 text-white" data-time="25">25m</button>
                        <button onclick="app.ftSetMode(45)" class="ft-mode-btn px-4 py-2 rounded-full text-xs font-bold transition-all hover:bg-white/20" data-time="45">45m</button>
                        <button onclick="app.ftSetMode(60)" class="ft-mode-btn px-4 py-2 rounded-full text-xs font-bold transition-all hover:bg-white/20" data-time="60">60m</button>
                    </div>
                </div>

                <!-- Countdown + controls -->
                <div class="flex items-center gap-4">
                    <div class="flex-1 text-center">
                        <div id="ft-timer-display" class="text-6xl md:text-7xl font-black timer-font text-slate-800 dark:text-slate-100 leading-none">25:00</div>
                        <p id="ft-timer-status" class="text-xs font-black uppercase tracking-[0.3em] text-indigo-500 mt-2">Ready to Focus</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="ft-btn" onclick="app.ftToggleTimer()" class="flex-1 btn-primary text-white py-4 rounded-2xl font-bold text-lg">
                        Start Focusing
                    </button>
                    <button onclick="app.ftResetTimer()" class="glass w-14 rounded-2xl flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors text-slate-500">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Stats row -->
            <div class="grid grid-cols-3 gap-3">
                <div class="glass p-4 rounded-2xl text-center">
                    <div id="ft-citizen-count" class="text-2xl font-black text-indigo-600 dark:text-indigo-400">2</div>
                    <div class="text-[10px] font-black uppercase tracking-widest text-slate-400 mt-1">Citizens</div>
                </div>
                <div class="glass p-4 rounded-2xl text-center">
                    <div id="ft-sessions-count" class="text-2xl font-black text-purple-600 dark:text-purple-400">0</div>
                    <div class="text-[10px] font-black uppercase tracking-widest text-slate-400 mt-1">Sessions</div>
                </div>
                <div class="glass p-4 rounded-2xl text-center">
                    <div id="ft-total-min" class="text-2xl font-black text-green-600 dark:text-green-400">0m</div>
                    <div class="text-[10px] font-black uppercase tracking-widest text-slate-400 mt-1">Total Focus</div>
                </div>
            </div>

            <!-- Stage milestones -->
            <div class="glass p-5 rounded-2xl">
                <div class="text-xs font-black uppercase tracking-widest text-slate-400 mb-4">Town Milestones</div>
                <div class="flex gap-2 flex-wrap">
                    <div class="ft-milestone flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold" data-stage="0">üåæ Village <span class="text-slate-400 font-normal ml-1">0 min</span></div>
                    <div class="ft-milestone flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold" data-stage="1">üè° Hamlet <span class="text-slate-400 font-normal ml-1">30 min</span></div>
                    <div class="ft-milestone flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold" data-stage="2">üèòÔ∏è Town <span class="text-slate-400 font-normal ml-1">2h</span></div>
                    <div class="ft-milestone flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold" data-stage="3">üèôÔ∏è City <span class="text-slate-400 font-normal ml-1">6h</span></div>
                    <div class="ft-milestone flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold" data-stage="4">üåÜ Metropolis <span class="text-slate-400 font-normal ml-1">15h</span></div>
                </div>
            </div>
        </div>
    </main>

    </div><!-- end #app-body -->

    <!-- ALARM OVERLAY -->
    <div id="alarm-overlay" class="fixed inset-0 z-[300] bg-gradient-to-br from-red-600 to-red-800 hidden flex flex-col items-center justify-center text-white p-10 text-center" onclick="app.stopAlarm()">
        <div class="ringing mb-8">
            <i data-lucide="alarm-clock" class="w-32 h-32 mx-auto"></i>
        </div>
        <h2 class="text-6xl md:text-8xl font-black mb-4 tracking-tighter">ALARM</h2>
        <p class="text-xl font-bold uppercase tracking-widest opacity-70 mb-8" id="alarm-time-display">--:--</p>
        <button class="px-8 py-4 bg-white/20 hover:bg-white/30 rounded-2xl font-bold text-lg backdrop-blur-sm transition-all">
            Tap anywhere to dismiss
        </button>
    </div>

    <!-- ON AIR OVERLAY -->
    <div id="onair-overlay" class="fixed inset-0 z-[250] hidden flex-col items-center justify-center text-white p-10 text-center onair-overlay" onclick="this.classList.add('hidden'); this.classList.remove('flex')">
        <div class="animate-pulse mb-8">
            <i data-lucide="radio" class="w-24 h-24 mx-auto opacity-80"></i>
        </div>
        <h2 id="onair-msg" class="text-6xl md:text-9xl font-black mb-6 tracking-tighter">ON AIR</h2>
        <p class="text-xl font-bold uppercase tracking-[0.5em] opacity-60">Click to exit</p>
    </div>

    <!-- PANIC OVERLAY -->
    <div id="panic-overlay" class="fixed inset-0 z-[400] bg-slate-950 hidden flex-col items-center justify-center text-white cursor-pointer" onclick="app.togglePrivacy()">
        <div class="animate-pulse mb-12">
            <i data-lucide="shield-check" class="w-24 h-24 text-slate-600"></i>
        </div>
        <h2 class="text-2xl font-bold uppercase tracking-[0.5em] text-slate-500 mb-4">Privacy Mode</h2>
        <p class="text-slate-600 text-sm">Click anywhere to return</p>
    </div>

    <!-- PIN MANAGER OVERLAY -->
    <div id="pin-overlay" class="fixed inset-0 z-[350] bg-slate-900/80 backdrop-blur-sm hidden flex-col items-center justify-center p-4" onclick="if(event.target === this) app.closePinManager()">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-3xl p-6 shadow-2xl border border-slate-200 dark:border-slate-700 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Add Quick Action</h3>
                <button onclick="app.closePinManager()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="pin-options" class="grid grid-cols-1 md:grid-cols-2 gap-3 overflow-y-auto p-1"></div>
        </div>
    </div>

    <script>
        // Main Application Object
        const app = {
            // State
            currentTab: 'dashboard',
            alarmTime: localStorage.getItem('wd_alarm') || null,
            musicPlaying: false,
            musicAudio: null,
            musicCtx: null,
            musicAnalyser: null,
            vizAnimation: null,
            alarmTriggered: false,
            waterCount: parseInt(localStorage.getItem('wd_water') || '0'),
            tasks: [],
            taskFilter: 'all',
            wbColor: '#000000',
            wbLineWidth: 3,
            wbHistory: [],
            wbHistoryStep: -1,
            audioCtx: null,
            noiseNode: null,
            gainNode: null,
            currentNoise: null,
            timerInterval: null,
            timerTime: 25 * 60,
            timerRunning: false,
            timerMode: 25,
            timerSessions: parseInt(localStorage.getItem('wd_sessions') || '0'),
            timerTotalMinutes: parseInt(localStorage.getItem('wd_total_min') || '0'),
            mediaRecorder: null,
            recordedChunks: [],
            recordingStartTime: null,
            recordingTimer: null,
            pdfFiles: [],
            draggedElement: null,
            weatherUnit: 'F',
            weatherTempC: null,
            calcValue: '0',
            calcHistory: '',
            draggedTaskIndex: null,
            searchItems: [
                { id: 'dashboard', label: 'Dashboard', icon: 'home', keywords: 'home start' },
                { id: 'scratchpad', label: 'Scratchpad', icon: 'file-text', keywords: 'notes write text editor' },
                { id: 'tasks', label: 'Task Manager', icon: 'check-circle-2', keywords: 'todo list jobs' },
                { id: 'board', label: 'Project Board', icon: 'columns', keywords: 'kanban agile trello' },
                { id: 'whiteboard', label: 'Whiteboard', icon: 'pencil', keywords: 'draw sketch paint' },
                { id: 'clock', label: 'Desk Clock', icon: 'clock', keywords: 'time alarm watch' },
                { id: 'timer', label: 'Focus Timer', icon: 'hourglass', keywords: 'pomodoro countdown focus' },
                { id: 'audio', label: 'Sound Studio', icon: 'headphones', keywords: 'noise ambient music white noise' },
                { id: 'breathing', label: 'Breathing Guide', icon: 'wind', keywords: 'meditate relax stress box breathing' },
                { id: 'calculator', label: 'Calculator', icon: 'calculator', keywords: 'math numbers' },
                { id: 'pdf', label: 'PDF Merger', icon: 'file-stack', keywords: 'combine join documents' },
                { id: 'zones', label: 'Time Zones', icon: 'globe-2', keywords: 'world clock global' },
                { id: 'onair', label: 'On Air', icon: 'radio', keywords: 'status busy sign' },
                { id: 'recorder', label: 'Screen Recorder', icon: 'video', keywords: 'capture screen video' },
                { id: 'stopwatch', label: 'Stopwatch', icon: 'timer', keywords: 'lap time elapsed counter' },
                { id: 'converter', label: 'Unit Converter', icon: 'arrow-left-right', keywords: 'convert length weight temperature speed volume' },
                { id: 'colorpicker', label: 'Color Picker', icon: 'palette', keywords: 'hex rgb hsl color swatch' },
                { id: 'focustown', label: 'Focus Town', icon: 'building-2', keywords: 'rpg village city town grow gamify focus' }
            ],
            pins: [],
            
            // Stopwatch State
            swInterval: null,
            swRunning: false,
            swElapsed: 0,
            swLapStart: 0,
            swLaps: [],

            // Converter State
            converterCategory: 'length',
            converterData: {
                length: {
                    units: ['mm','cm','m','km','in','ft','yd','mi'],
                    base: 'm',
                    factors: { mm: 0.001, cm: 0.01, m: 1, km: 1000, in: 0.0254, ft: 0.3048, yd: 0.9144, mi: 1609.344 }
                },
                weight: {
                    units: ['mg','g','kg','t','oz','lb'],
                    base: 'kg',
                    factors: { mg: 0.000001, g: 0.001, kg: 1, t: 1000, oz: 0.0283495, lb: 0.453592 }
                },
                temp: {
                    units: ['¬∞C','¬∞F','K'],
                    special: true
                },
                volume: {
                    units: ['ml','L','tsp','tbsp','cup','pt','qt','gal'],
                    base: 'L',
                    factors: { ml: 0.001, L: 1, tsp: 0.00492892, tbsp: 0.0147868, cup: 0.236588, pt: 0.473176, qt: 0.946353, gal: 3.78541 }
                },
                speed: {
                    units: ['m/s','km/h','mph','knot'],
                    base: 'm/s',
                    factors: { 'm/s': 1, 'km/h': 0.277778, mph: 0.44704, knot: 0.514444 }
                }
            },

            // Color Picker State
            cpColor: { r: 79, g: 70, b: 229 },
            cpSwatches: [],

            // Focus Town State
            ftMinutes: parseInt(localStorage.getItem('wd_ft_minutes') || '0'),
            ftRunning: false,
            ftInterval: null,
            ftMode: 25,
            ftTime: 25 * 60,
            ftSessions: parseInt(localStorage.getItem('wd_ft_sessions') || '0'),
            ftStageNames: ['Village', 'Hamlet', 'Town', 'City', 'Metropolis'],
            ftStageEmoji: ['üåæ', 'üè°', 'üèòÔ∏è', 'üèôÔ∏è', 'üåÜ'],
            ftStageThresholds: [0, 30, 120, 360, 900],
            ftBuildings: [
                // Stage 0 ‚Äî Village
                [{e:'üå≤',s:1.8},{e:'üè†',s:2.2},{e:'üå≥',s:2.0},{e:'üè°',s:2.4},{e:'üå≤',s:1.7}],
                // Stage 1 ‚Äî Hamlet
                [{e:'üå≤',s:1.8},{e:'üè†',s:2.3},{e:'üå≥',s:2.0},{e:'üè°',s:2.5},{e:'üè™',s:2.4},{e:'üå≤',s:1.9},{e:'üè†',s:2.1},{e:'üå≥',s:1.8}],
                // Stage 2 ‚Äî Town
                [{e:'üå≤',s:1.7},{e:'üè†',s:2.2},{e:'üè°',s:2.4},{e:'üèòÔ∏è',s:2.6},{e:'üè™',s:2.5},{e:'üå≥',s:2.0},{e:'üè´',s:2.8},{e:'üè†',s:2.1},{e:'üå≤',s:1.8},{e:'üè°',s:2.3}],
                // Stage 3 ‚Äî City
                [{e:'üå≤',s:1.7},{e:'üè†',s:2.0},{e:'üè¢',s:3.0},{e:'üè¨',s:3.2},{e:'üè¶',s:2.8},{e:'üå≥',s:1.9},{e:'üè™',s:2.4},{e:'üè¢',s:3.1},{e:'üè´',s:2.7},{e:'üè†',s:2.0},{e:'üè¢',s:2.9},{e:'üå≤',s:1.8}],
                // Stage 4 ‚Äî Metropolis
                [{e:'üå≤',s:1.7},{e:'üè¢',s:3.2},{e:'üè¢',s:3.5},{e:'üèõÔ∏è',s:3.3},{e:'üèüÔ∏è',s:3.0},{e:'üè¶',s:3.2},{e:'üè¢',s:3.6},{e:'üè¨',s:3.1},{e:'üè¢',s:3.4},{e:'üè¢',s:3.5},{e:'üèõÔ∏è',s:3.0},{e:'üå≤',s:1.7},{e:'üè¢',s:3.3}]
            ],

            // Breathing State
            breathActive: false,
            breathMuted: false,
            breathTechnique: 'box',
            breathTimeouts: [],
            breathConfig: {
                box: { phases: [{ l: 'Inhale', d: 4000, s: 1 }, { l: 'Hold', d: 4000, s: 1 }, { l: 'Exhale', d: 4000, s: 0.5 }, { l: 'Hold', d: 4000, s: 0.5 }], desc: 'Equal breathing for focus and stress reduction.' },
                '478': { phases: [{ l: 'Inhale', d: 4000, s: 1 }, { l: 'Hold', d: 7000, s: 1 }, { l: 'Exhale', d: 8000, s: 0.5 }], desc: 'Natural tranquilizer for the nervous system.' },
                coherence: { phases: [{ l: 'Inhale', d: 6000, s: 1 }, { l: 'Exhale', d: 6000, s: 0.5 }], desc: 'Balances heart rate variability (HRV).' }
            },

            _rebuildIcons() {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            },

            // Initialize
            init() {
                // Safe load data
                try {
                    this.tasks = JSON.parse(localStorage.getItem('wd_tasks') || '[]');
                } catch(e) { this.tasks = []; }
                if (!Array.isArray(this.tasks)) this.tasks = [];

                try {
                    this.pins = JSON.parse(localStorage.getItem('wd_pins') || '[]');
                    if (!Array.isArray(this.pins)) {
                        throw new Error("Pins is not an array");
                    }
                } catch(e) {
                    this.pins = [
                        {id: 'recorder', label: 'Record Screen'}, 
                        {id: 'pdf', label: 'Merge PDFs'}, 
                        {id: 'onair', label: 'On Air Sign'}
                    ];
                }
                
                // Theme
                if (localStorage.getItem('webdesks_theme') === 'dark') {
                    document.documentElement.classList.add('dark');
                }

                // Load saved tab or default
                const savedTab = localStorage.getItem('webdesks_last_tab') || 'dashboard';
                this.switchTab(savedTab);

                // Initialize components
                this.initTime();
                this.initWeather();
                this.initWhiteboard();
                this.initScratchpad();
                this.initQuote();
                this.renderTasks();
                this.renderWater();
                this.updateAlarmUI();
                this.updateTimerStats();
                this.initZones();
                this.initPDFDrop();
                this.renderPins();
                this.initConverter();
                this.initColorPicker();
                this.initFocusTown();

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        document.getElementById('dash-search').focus();
                    }
                    if (e.altKey && e.key === 'p') {
                        e.preventDefault();
                        this.togglePrivacy();
                    }
                    if (e.altKey && e.key === 'z') {
                        e.preventDefault();
                        this.toggleZenMode();
                    }
                });

                // Auto-save scratchpad
                const noteArea = document.getElementById('note-area');
                noteArea.value = localStorage.getItem('wd_scratch') || '';
                noteArea.addEventListener('input', () => {
                    localStorage.setItem('wd_scratch', noteArea.value);
                    this.updateNotePreview();
                });
                this.updateNotePreview();

                // Daily focus
                const focus = document.getElementById('daily-focus');
                focus.value = localStorage.getItem('wd_focus') || '';
                focus.addEventListener('input', () => {
                    localStorage.setItem('wd_focus', focus.value);
                });
            },

            // Navigation
            switchTab(tabId) {
                if (!document.getElementById(tabId)) tabId = 'dashboard';
                if (this.currentTab === tabId) return;
                
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                const target = document.getElementById(tabId);
                if (target) {
                    target.classList.add('active');
                    // Small delay for whiteboard resize
                    if (tabId === 'whiteboard') {
                        setTimeout(() => this.resizeCanvas(), 100);
                    }
                }
                
                const btn = document.querySelector(`.nav-btn[data-tab="${tabId}"]`);
                if (btn) btn.classList.add('active');

                localStorage.setItem('webdesks_last_tab', tabId);
                this.currentTab = tabId;
                this._rebuildIcons();
            },

            // Search
            handleSearch(query) {
                const container = document.getElementById('search-results');
                if (!query.trim()) {
                    container.classList.add('hidden');
                    container.innerHTML = '';
                    return;
                }

                const term = query.toLowerCase();
                const matches = this.searchItems.filter(item => 
                    item.label.toLowerCase().includes(term) || 
                    item.keywords.includes(term)
                );

                container.classList.remove('hidden');
                
                if (matches.length > 0) {
                    container.innerHTML = matches.map(item => `
                        <button onclick="app.switchTab('${item.id}'); document.getElementById('dash-search').value = ''; app.handleSearch('')" 
                            class="flex items-center gap-3 p-3 rounded-xl hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors text-left group w-full">
                            <div class="p-2 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 group-hover:scale-110 transition-transform">
                                <i data-lucide="${item.icon}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm text-slate-700 dark:text-slate-200">${item.label}</div>
                                <div class="text-[10px] text-slate-400 uppercase tracking-wider">Switch Tab</div>
                            </div>
                        </button>
                    `).join('');
                    this._rebuildIcons();
                } else {
                    container.innerHTML = `<div class="col-span-full text-center text-slate-400 py-4 text-sm">No tools found for "${this.escapeHtml(query)}"</div>`;
                }
            },

            // Pins / Quick Actions
            renderPins() {
                const container = document.getElementById('quick-actions-grid');
                if (!container) return;
                
                container.innerHTML = this.pins.map((pin, index) => {
                    const tool = this.searchItems.find(i => i.id === pin.id);
                    if (!tool) return '';
                    
                    return `
                    <button 
                        onclick="app.switchTab('${pin.id}')" 
                        ondblclick="app.editPin(${index})"
                        class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 text-sm font-medium transition-colors flex items-center gap-2 group relative select-none"
                        title="Double-click to edit"
                    >
                        <i data-lucide="${tool.icon}" class="w-4 h-4 text-slate-500 group-hover:text-indigo-600 transition-colors"></i> 
                        <span class="text-slate-700 dark:text-slate-200 group-hover:text-indigo-700 dark:group-hover:text-indigo-300">${this.escapeHtml(pin.label || tool.label)}</span>
                    </button>
                    `;
                }).join('');
                this._rebuildIcons();
            },

            editPin(index) {
                const pin = this.pins[index];
                const newLabel = prompt("Edit label (clear to remove):", pin.label);
                
                if (newLabel === null) return;
                
                if (newLabel.trim() === "") {
                    this.pins.splice(index, 1);
                } else {
                    this.pins[index].label = newLabel.trim();
                }
                this.savePins();
            },

            savePins() {
                localStorage.setItem('wd_pins', JSON.stringify(this.pins));
                this.renderPins();
            },

            openPinManager() {
                const overlay = document.getElementById('pin-overlay');
                const container = document.getElementById('pin-options');
                const pinnedIds = this.pins.map(p => p.id);
                const available = this.searchItems.filter(i => !pinnedIds.includes(i.id));
                
                container.innerHTML = available.length ? available.map(item => `
                    <button onclick="app.addPin('${item.id}')" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-left group border border-transparent hover:border-indigo-500/30">
                        <div class="p-2 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600">
                            <i data-lucide="${item.icon}" class="w-4 h-4"></i>
                        </div>
                        <span class="font-medium text-sm">${item.label}</span>
                        <i data-lucide="plus" class="w-4 h-4 ml-auto text-slate-400 group-hover:text-indigo-500"></i>
                    </button>
                `).join('') : '<div class="col-span-full text-center text-slate-400 py-8">All tools are pinned!</div>';
                
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                this._rebuildIcons();
            },

            addPin(id) {
                const tool = this.searchItems.find(i => i.id === id);
                if (tool) {
                    this.pins.push({ id: tool.id, label: tool.label });
                    this.savePins();
                    this.openPinManager();
                }
            },

            closePinManager() {
                document.getElementById('pin-overlay').classList.add('hidden');
                document.getElementById('pin-overlay').classList.remove('flex');
            },

            // Theme
            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('webdesks_theme', isDark ? 'dark' : 'light');
            },

            // Privacy Mode
            togglePrivacy() {
                document.body.classList.toggle('panic-mode');
                const overlay = document.getElementById('panic-overlay');
                const isPanic = document.body.classList.contains('panic-mode');
                
                if (isPanic) {
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                    document.title = "Privacy Protected";
                } else {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    document.title = "WebDesks OS";
                }
            },

            // Zen Mode
            toggleZenMode() {
                document.body.classList.toggle('zen-mode');
                setTimeout(() => {
                    this.resizeCanvas();
                    window.dispatchEvent(new Event('resize'));
                }, 100);
            },

            // Time & Dashboard
            initTime() {
                const update = () => {
                    const now = new Date();
                    const h = now.getHours();

                    // Time strings
                    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    const timeStrSec = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                    const secStr = now.getSeconds().toString().padStart(2, '0');
                    const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    const dateShort = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                    // Header clock (always visible)
                    const ht = document.getElementById('header-time');
                    const hd = document.getElementById('header-date');
                    if (ht) ht.textContent = timeStrSec;
                    if (hd) hd.textContent = dateShort;

                    // Desk Clock tab
                    document.getElementById('full-clock').textContent = timeStr;
                    document.getElementById('full-date').textContent = dateStr;

                    // Greeting
                    let greeting = "Good Morning";
                    if (h >= 12) greeting = "Good Afternoon";
                    if (h >= 17) greeting = "Good Evening";
                    if (h >= 21) greeting = "Good Night";
                    const greetEl = document.getElementById('greeting');
                    if (greetEl) greetEl.textContent = greeting;

                    // Alarm check
                    if (this.alarmTime && !this.alarmTriggered) {
                        const currentH = now.getHours().toString().padStart(2, '0');
                        const currentM = now.getMinutes().toString().padStart(2, '0');
                        if (`${currentH}:${currentM}` === this.alarmTime && now.getSeconds() === 0) {
                            this.triggerAlarm();
                        }
                    }
                };
                update();
                setInterval(update, 1000);
            },

            // Weather
            async initWeather() {
                if (!navigator.geolocation) return;
                
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                    });
                    
                    const { latitude, longitude } = position.coords;
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                    const data = await res.json();
                    
                    this.weatherTempC = Math.round(data.current_weather.temperature);
                    this.renderWeather();
                    
                    // Weather icon based on code
                    const code = data.current_weather.weathercode;
                    const iconEl = document.getElementById('weather-icon');
                    let iconName = 'sun';
                    if (code > 3) iconName = 'cloud';
                    if (code > 50) iconName = 'cloud-rain';
                    if (code > 70) iconName = 'snowflake';
                    
                    iconEl.innerHTML = `<i data-lucide="${iconName}" class="w-16 h-16 text-orange-500"></i>`;
                    this._rebuildIcons();
                } catch (e) {
                    document.getElementById('weather-temp').textContent = '--¬∞C';
                }
            },

            renderWeather() {
                if (this.weatherTempC === null) return;
                const isC = this.weatherUnit === 'C';
                const temp = isC ? this.weatherTempC : Math.round((this.weatherTempC * 9/5) + 32);
                document.getElementById('weather-temp').textContent = `${temp}¬∞${this.weatherUnit}`;
            },

            toggleWeatherUnit() {
                this.weatherUnit = this.weatherUnit === 'C' ? 'F' : 'C';
                this.renderWeather();
            },

            // Daily Quote
            async initQuote() {
                const saved = JSON.parse(localStorage.getItem('wd_quote') || 'null');
                const today = new Date().toDateString();

                if (saved && saved.date === today) {
                    this.renderQuote(saved.text, saved.author);
                    return;
                }

                const fallbacks = [
                    { text: "The best way to predict the future is to invent it.", author: "Alan Kay" },
                    { text: "Simplicity is the ultimate sophistication.", author: "Leonardo da Vinci" },
                    { text: "Code is like humor. When you have to explain it, it‚Äôs bad.", author: "Cory House" },
                    { text: "Fix the cause, not the symptom.", author: "Steve Maguire" },
                    { text: "Make it work, make it right, make it fast.", author: "Kent Beck" }
                ];

                try {
                    const res = await fetch('https://api.quotable.io/random?tags=technology,wisdom');
                    if (!res.ok) throw new Error('Network response was not ok');
                    const data = await res.json();
                    this.saveQuote(data.content, data.author);
                } catch (e) {
                    const random = fallbacks[Math.floor(Math.random() * fallbacks.length)];
                    this.saveQuote(random.text, random.author);
                }
            },

            saveQuote(text, author) {
                const quote = { text, author, date: new Date().toDateString() };
                localStorage.setItem('wd_quote', JSON.stringify(quote));
                this.renderQuote(text, author);
            },

            renderQuote(text, author) {
                const q = document.getElementById('daily-quote');
                const a = document.getElementById('quote-author');
                if (q) q.textContent = `"${text}"`;
                if (a) a.textContent = `- ${author}`;
            },

            // Alarm
            setAlarm() {
                const val = document.getElementById('alarm-input').value;
                if (!val) return;
                this.alarmTime = val;
                this.alarmTriggered = false;
                localStorage.setItem('wd_alarm', this.alarmTime);
                this.updateAlarmUI();
            },

            clearAlarm() {
                this.alarmTime = null;
                this.alarmTriggered = false;
                localStorage.removeItem('wd_alarm');
                this.updateAlarmUI();
            },

            updateAlarmUI() {
                const status = document.getElementById('dash-alarm-status');
                const btn = document.getElementById('alarm-btn');
                const bellIcon = document.getElementById('header-bell-icon');
                const alarmHeaderBtn = document.getElementById('header-alarm-btn');

                if (this.alarmTime) {
                    const [h, m] = this.alarmTime.split(':');
                    const date = new Date();
                    date.setHours(parseInt(h));
                    date.setMinutes(parseInt(m));
                    const displayTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

                    if (status) { status.textContent = displayTime; status.classList.add('text-orange-500'); }
                    if (btn) btn.textContent = 'Update Alarm';
                    // Header: switch to active bell
                    if (bellIcon) { bellIcon.setAttribute('data-lucide', 'bell'); bellIcon.classList.add('text-orange-500'); }
                    if (alarmHeaderBtn) alarmHeaderBtn.title = `Alarm set: ${displayTime}`;
                } else {
                    if (status) { status.textContent = '--:--'; status.classList.remove('text-orange-500'); }
                    if (btn) btn.textContent = 'Set Alarm';
                    // Header: switch to bell-off
                    if (bellIcon) { bellIcon.setAttribute('data-lucide', 'bell-off'); bellIcon.classList.remove('text-orange-500'); }
                    if (alarmHeaderBtn) alarmHeaderBtn.title = 'Alarm';
                }
                this._rebuildIcons();
            },

            triggerAlarm() {
                this.alarmTriggered = true;
                document.getElementById('alarm-overlay').classList.remove('hidden');
                document.getElementById('alarm-time-display').textContent = this.alarmTime;
                
                // Try to play sound
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
                    audio.loop = true;
                    audio.play().catch(() => {});
                    window.alarmAudio = audio;
                } catch(e) {}
            },

            stopAlarm() {
                document.getElementById('alarm-overlay').classList.add('hidden');
                if (window.alarmAudio) {
                    window.alarmAudio.pause();
                    window.alarmAudio = null;
                }
                this.clearAlarm();
            },

            // Hydration
            addWater() {
                this.waterCount = (this.waterCount + 1) % 9;
                if (this.waterCount === 0) this.waterCount = 1;
                this.renderWater();
            },

            renderWater() {
                const grid = document.getElementById('water-grid');
                grid.innerHTML = '';
                for (let i = 1; i <= 8; i++) {
                    const glass = document.createElement('div');
                    glass.className = `w-3 h-4 rounded-sm transition-all duration-300 ${i <= this.waterCount ? 'bg-blue-500 shadow-lg shadow-blue-500/50 scale-110' : 'bg-slate-200 dark:bg-slate-700'}`;
                    grid.appendChild(glass);
                }
                localStorage.setItem('wd_water', this.waterCount);
            },

            // Scratchpad
            initScratchpad() {
                this.updateNotePreview();
            },

            updateNotePreview() {
                const note = document.getElementById('note-area').value;
                const preview = document.getElementById('dash-note-preview');
                const wordCount = document.getElementById('word-count');
                
                const words = note.trim() ? note.trim().split(/\s+/).length : 0;
                if (wordCount) wordCount.textContent = `${words} word${words !== 1 ? 's' : ''}`;
                
                if (preview) {
                    preview.textContent = note.slice(0, 60) || "Start writing...";
                    if (note.length > 60) preview.textContent += '...';
                }
            },

            downloadNote() {
                const text = document.getElementById('note-area').value;
                if (!text) return;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `webdesks_note_${new Date().toISOString().slice(0,10)}.txt`;
                a.click();
            },

            copyNote() {
                const text = document.getElementById('note-area').value;
                if (!text) return;
                navigator.clipboard.writeText(text).then(() => {
                    this.showToast('Copied to clipboard!');
                });
            },

            // Tasks
            renderTasks() {
                const list = document.getElementById('task-list');
                const stats = document.getElementById('task-stats');
                
                let filtered = this.tasks;
                if (this.taskFilter === 'active') filtered = this.tasks.filter(t => !t.done);
                if (this.taskFilter === 'completed') filtered = this.tasks.filter(t => t.done);
                
                const activeCount = this.tasks.filter(t => !t.done).length;
                stats.textContent = `${activeCount} active ‚Ä¢ ${this.tasks.length} total`;

                if (filtered.length === 0) {
                    list.innerHTML = `
                        <div class="text-center text-slate-400 py-12">
                            <i data-lucide="check-circle-2" class="w-12 h-12 mx-auto mb-4 opacity-30"></i>
                            <p>${this.taskFilter === 'all' ? 'No tasks yet. Add one above!' : 'No tasks in this filter.'}</p>
                        </div>`;
                } else {
                    list.innerHTML = filtered.map((t, i) => {
                        const originalIndex = this.tasks.indexOf(t);
                        return `
                        <div draggable="true" 
                            ondragstart="app.dragTaskStart(event, ${originalIndex})"
                            ondragover="app.allowTaskDrop(event)"
                            ondrop="app.dropTask(event, ${originalIndex})"
                            ondragend="app.dragTaskEnd(event)"
                            class="glass p-4 rounded-xl flex justify-between items-center group hover:shadow-lg transition-all cursor-move ${t.done ? 'opacity-50' : ''}">
                            <div class="flex items-center gap-3 flex-1">
                                <button onclick="app.toggleTask(${originalIndex})" class="w-6 h-6 rounded-full border-2 ${t.done ? 'bg-green-500 border-green-500' : 'border-slate-300 dark:border-slate-600'} flex items-center justify-center transition-all">
                                    ${t.done ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : ''}
                                </button>
                                <div class="flex-1">
                                    <span class="font-medium ${t.done ? 'line-through text-slate-400' : ''}">${this.escapeHtml(t.text)}</span>
                                    ${t.time ? `<span class="ml-2 text-[10px] font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 rounded-full">${t.time}</span>` : ''}
                                </div>
                            </div>
                            <button onclick="app.removeTask(${originalIndex})" class="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all p-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>`;
                    }).join('');
                }
                
                localStorage.setItem('wd_tasks', JSON.stringify(this.tasks));
                this._rebuildIcons();
            },

            addTask() {
                const input = document.getElementById('task-input');
                const timeInput = document.getElementById('task-time');
                const text = input.value.trim();
                
                if (!text) return;
                
                this.tasks.push({ 
                    text, 
                    time: timeInput.value, 
                    done: false,
                    id: Date.now()
                });
                
                input.value = '';
                timeInput.value = '';
                this.renderTasks();
            },

            toggleTask(index) {
                this.tasks[index].done = !this.tasks[index].done;
                this.renderTasks();
            },

            removeTask(index) {
                this.tasks.splice(index, 1);
                this.renderTasks();
            },

            filterTasks(filter) {
                this.taskFilter = filter;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                    if (btn.dataset.filter === filter) {
                        btn.classList.add('active', 'bg-indigo-600', 'text-white');
                    }
                });
                this.renderTasks();
            },

            dragTaskStart(e, index) {
                this.draggedTaskIndex = index;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            },

            allowTaskDrop(e) {
                e.preventDefault();
            },

            dropTask(e, targetIndex) {
                e.preventDefault();
                const fromIndex = this.draggedTaskIndex;
                if (fromIndex === null || fromIndex === targetIndex) return;
                this.tasks.splice(targetIndex, 0, this.tasks.splice(fromIndex, 1)[0]);
                this.draggedTaskIndex = null;
                this.renderTasks();
            },

            dragTaskEnd(e) {
                e.target.classList.remove('dragging');
                this.draggedTaskIndex = null;
            },

            // Kanban Board
            addBoardItem(col) {
                const text = prompt("Enter task name:");
                if (!text) return;
                
                const item = document.createElement('div');
                item.className = "glass p-3 rounded-xl text-sm font-medium shadow-sm cursor-move hover:shadow-md transition-all border-l-4 border-indigo-500";
                item.draggable = true;
                item.textContent = text;
                
                item.addEventListener('dragstart', (e) => {
                    this.draggedElement = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    this.draggedElement = null;
                    this.updateBoardCounts();
                });
                
                item.addEventListener('click', (e) => {
                    if (confirm('Delete this task?')) {
                        item.remove();
                        this.updateBoardCounts();
                    }
                });
                
                document.getElementById(`kb-${col}`).appendChild(item);
                this.updateBoardCounts();
            },

            allowDrop(e) {
                e.preventDefault();
                e.currentTarget.classList.add('drop-zone');
            },

            drop(e, col) {
                e.preventDefault();
                e.currentTarget.classList.remove('drop-zone');
                if (this.draggedElement) {
                    e.currentTarget.appendChild(this.draggedElement);
                    
                    // Update border color based on column
                    const borders = { todo: 'border-slate-400', doing: 'border-indigo-500', done: 'border-green-500' };
                    this.draggedElement.className = this.draggedElement.className.replace(/border-\w+-500/, borders[col]);
                    
                    this.updateBoardCounts();
                }
            },

            updateBoardCounts() {
                ['todo', 'doing', 'done'].forEach(col => {
                    const count = document.getElementById(`kb-${col}`).children.length;
                    document.getElementById(`count-${col}`).textContent = count;
                });
            },

            clearBoard() {
                if (confirm('Clear all board items?')) {
                    ['todo', 'doing', 'done'].forEach(col => {
                        document.getElementById(`kb-${col}`).innerHTML = '';
                    });
                    this.updateBoardCounts();
                }
            },

            // Whiteboard
            initWhiteboard() {
                const canvas = document.getElementById('wb-canvas');
                const ctx = canvas.getContext('2d');
                
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                let drawing = false;
                let lastX = 0;
                let lastY = 0;
                
                const startDrawing = (e) => {
                    drawing = true;
                    [lastX, lastY] = this.getCoordinates(e, canvas);
                    this.saveWBState();
                };
                
                const draw = (e) => {
                    if (!drawing) return;
                    e.preventDefault();
                    
                    const [x, y] = this.getCoordinates(e, canvas);
                    
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.strokeStyle = this.wbColor;
                    ctx.lineWidth = this.wbLineWidth;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.stroke();
                    
                    [lastX, lastY] = [x, y];
                };
                
                const stopDrawing = () => {
                    drawing = false;
                };
                
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                
                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    startDrawing(e.touches[0]);
                }, { passive: false });
                
                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    draw(e.touches[0]);
                }, { passive: false });
                
                canvas.addEventListener('touchend', stopDrawing);
                
                // Initial state
                this.saveWBState();
            },

            getCoordinates(e, canvas) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.pageX) - rect.left;
                const y = (e.clientY || e.pageY) - rect.top;
                return [x, y];
            },

            resizeCanvas() {
                const canvas = document.getElementById('wb-canvas');
                const parent = canvas.parentElement;
                
                // Save current content
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                if (canvas.width > 0) tempCtx.drawImage(canvas, 0, 0);
                
                canvas.width = parent.offsetWidth;
                canvas.height = parent.offsetHeight;
                
                // Restore content
                if (tempCanvas.width > 0) {
                    canvas.getContext('2d').drawImage(tempCanvas, 0, 0);
                }
            },

            saveWBState() {
                const canvas = document.getElementById('wb-canvas');
                if (this.wbHistoryStep < this.wbHistory.length - 1) {
                    this.wbHistory = this.wbHistory.slice(0, this.wbHistoryStep + 1);
                }
                this.wbHistory.push(canvas.toDataURL());
                this.wbHistoryStep++;
                if (this.wbHistory.length > 20) {
                    this.wbHistory.shift();
                    this.wbHistoryStep--;
                }
            },

            undoWB() {
                if (this.wbHistoryStep > 0) {
                    this.wbHistoryStep--;
                    const canvas = document.getElementById('wb-canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.src = this.wbHistory[this.wbHistoryStep];
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                    };
                }
            },

            setWBColor(color) {
                this.wbColor = color;
                document.querySelectorAll('.color-btn').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-indigo-500');
                    if (btn.dataset.color === color) {
                        btn.classList.add('ring-2', 'ring-indigo-500');
                    }
                });
            },

            setLineWidth(width) {
                this.wbLineWidth = width;
            },

            clearWB() {
                if (confirm('Clear whiteboard?')) {
                    const canvas = document.getElementById('wb-canvas');
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    this.saveWBState();
                }
            },

            downloadWB() {
                const canvas = document.getElementById('wb-canvas');
                const link = document.createElement('a');
                link.download = `whiteboard_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            },

            // Focus Timer
            setTimerMode(minutes) {
                this.timerMode = minutes;
                this.timerTime = minutes * 60;
                this.updateTimerDisplay();
                
                document.querySelectorAll('.timer-mode-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('hover:bg-white/20');
                    if (parseInt(btn.dataset.time) === minutes) {
                        btn.classList.add('bg-indigo-600', 'text-white');
                        btn.classList.remove('hover:bg-white/20');
                    }
                });
            },

            toggleTimer() {
                if (this.timerRunning) {
                    this.pauseTimer();
                } else {
                    this.startTimer();
                }
            },

            startTimer() {
                this.timerRunning = true;
                document.getElementById('timer-btn').textContent = 'Pause';
                document.getElementById('timer-status').textContent = 'Focusing...';
                document.getElementById('timer-status').classList.add('animate-pulse');
                
                this.timerInterval = setInterval(() => {
                    this.timerTime--;
                    this.updateTimerDisplay();
                    
                    if (this.timerTime <= 0) {
                        this.completeTimer();
                    }
                }, 1000);
            },

            pauseTimer() {
                this.timerRunning = false;
                clearInterval(this.timerInterval);
                document.getElementById('timer-btn').textContent = 'Resume';
                document.getElementById('timer-status').textContent = 'Paused';
                document.getElementById('timer-status').classList.remove('animate-pulse');
            },

            resetTimer() {
                this.pauseTimer();
                this.timerTime = this.timerMode * 60;
                this.updateTimerDisplay();
                document.getElementById('timer-btn').textContent = 'Start Focus';
                document.getElementById('timer-status').textContent = 'Ready to Focus';
            },

            completeTimer() {
                this.pauseTimer();
                this.timerSessions++;
                this.timerTotalMinutes += this.timerMode;
                localStorage.setItem('wd_sessions', this.timerSessions);
                localStorage.setItem('wd_total_min', this.timerTotalMinutes);
                this.updateTimerStats();
                
                // Notification
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Focus Complete!', { body: `Great job! You completed ${this.timerMode} minutes of focused work.` });
                }
                
                this.showToast('Focus session complete! üéâ');
                this.resetTimer();
            },

            updateTimerDisplay() {
                const m = Math.floor(this.timerTime / 60);
                const s = this.timerTime % 60;
                document.getElementById('timer-display').textContent = 
                    `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                document.getElementById('mini-timer').textContent = 
                    `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            },

            updateTimerStats() {
                document.getElementById('session-count').textContent = this.timerSessions;
                document.getElementById('total-focus').textContent = `${this.timerTotalMinutes}m`;
            },

            // Audio
            toggleNoise(type) {
                if (this.currentNoise === type) {
                    this.stopNoise();
                    return;
                }
                
                this.stopNoise();
                this.currentNoise = type;
                
                if (!this.audioCtx) {
                    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const bufferSize = 2 * this.audioCtx.sampleRate;
                const buffer = this.audioCtx.createBuffer(1, bufferSize, this.audioCtx.sampleRate);
                const output = buffer.getChannelData(0);
                
                // Generate noise based on type
                if (type === 'white') {
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = Math.random() * 2 - 1;
                    }
                } else if (type === 'pink') {
                    let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        b0 = 0.99886 * b0 + white * 0.0555179;
                        b1 = 0.99332 * b1 + white * 0.0750759;
                        b2 = 0.96900 * b2 + white * 0.1538520;
                        b3 = 0.86650 * b3 + white * 0.3104856;
                        b4 = 0.55000 * b4 + white * 0.5329522;
                        b5 = -0.7616 * b5 - white * 0.0168980;
                        output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                        output[i] *= 0.11;
                        b6 = white * 0.115926;
                    }
                } else if (type === 'brown') {
                    let lastOut = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        output[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = output[i];
                        output[i] *= 3.5;
                    }
                } else if (type === 'nature') {
                    // Simulated nature (mix of brown and occasional bird-like chirps)
                    let lastOut = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        output[i] = (lastOut + (0.01 * white)) / 1.01;
                        lastOut = output[i];
                        output[i] *= 2;
                    }
                }
                
                this.noiseNode = this.audioCtx.createBufferSource();
                this.noiseNode.buffer = buffer;
                this.noiseNode.loop = true;
                
                this.gainNode = this.audioCtx.createGain();
                this.gainNode.gain.value = 0.3;
                
                // Filter for nature sound
                if (type === 'nature') {
                    const filter = this.audioCtx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.value = 1000;
                    this.noiseNode.connect(filter).connect(this.gainNode).connect(this.audioCtx.destination);
                } else {
                    this.noiseNode.connect(this.gainNode).connect(this.audioCtx.destination);
                }
                
                this.noiseNode.start();
                
                // Update UI
                document.querySelectorAll('.noise-btn').forEach(btn => {
                    btn.classList.remove('border-indigo-500', 'border-pink-500', 'border-amber-700', 'border-green-500');
                    btn.querySelector('.playing-indicator').classList.add('hidden');
                });
                
                const activeBtn = document.getElementById(`noise-${type}`);
                const colors = { white: 'indigo', pink: 'pink', brown: 'amber', nature: 'green' };
                activeBtn.classList.add(`border-${colors[type]}-500`);
                activeBtn.querySelector('.playing-indicator').classList.remove('hidden');
            },

            stopNoise() {
                if (this.noiseNode) {
                    this.noiseNode.stop();
                    this.noiseNode = null;
                }
                this.currentNoise = null;
                document.querySelectorAll('.noise-btn').forEach(btn => {
                    btn.classList.remove('border-indigo-500', 'border-pink-500', 'border-amber-700', 'border-green-500');
                    btn.querySelector('.playing-indicator').classList.add('hidden');
                });
            },

            setVolume(val) {
                if (this.gainNode) {
                    this.gainNode.gain.value = parseFloat(val);
                }
                document.getElementById('vol-display').textContent = Math.round(val * 100) + '%';
            },

            // Breathing Guide
            setBreathTechnique(tech) {
                if (this.breathActive) this.stopBreathing();
                this.breathTechnique = tech;
                
                document.querySelectorAll('.breath-btn').forEach(b => {
                    b.classList.remove('bg-indigo-600', 'text-white');
                    b.classList.add('glass', 'hover:bg-white/50');
                    if (b.dataset.tech === tech) {
                        b.classList.remove('glass', 'hover:bg-white/50');
                        b.classList.add('bg-indigo-600', 'text-white');
                    }
                });
                
                document.getElementById('breath-desc').textContent = this.breathConfig[tech].desc;
            },

            toggleBreathing() {
                if (this.breathActive) this.stopBreathing();
                else this.startBreathing();
            },

            startBreathing() {
                this.breathActive = true;
                document.getElementById('breath-toggle').textContent = 'Stop Session';
                document.getElementById('breath-toggle').classList.replace('btn-primary', 'bg-slate-500');
                this.runBreathPhase(0);
            },

            stopBreathing() {
                this.breathActive = false;
                this.breathTimeouts.forEach(clearTimeout);
                this.breathTimeouts = [];
                
                document.getElementById('breath-toggle').textContent = 'Start Breathing';
                document.getElementById('breath-toggle').classList.replace('bg-slate-500', 'btn-primary');
                document.getElementById('breath-instruction').textContent = 'Ready';
                
                const c1 = document.getElementById('breath-circle');
                const c2 = document.getElementById('breath-circle-inner');
                if(c1) {
                    c1.style.transform = 'scale(0.5)';
                    c1.style.transitionDuration = '0.5s';
                }
                if(c2) {
                    c2.style.transform = 'scale(0.5)';
                    c2.style.transitionDuration = '0.5s';
                }
            },

            toggleBreathMute() {
                this.breathMuted = !this.breathMuted;
                const btn = document.getElementById('breath-mute-btn');
                if (this.breathMuted) {
                    btn.innerHTML = '<i data-lucide="volume-x" class="w-5 h-5"></i>';
                    btn.classList.add('text-red-500');
                } else {
                    btn.innerHTML = '<i data-lucide="volume-2" class="w-5 h-5"></i>';
                    btn.classList.remove('text-red-500');
                }
                this._rebuildIcons();
            },

            playBreathTone() {
                if (this.breathMuted) return;
                try {
                    if (!this.audioCtx) {
                        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    if (this.audioCtx.state === 'suspended') {
                        this.audioCtx.resume();
                    }

                    const osc = this.audioCtx.createOscillator();
                    const gain = this.audioCtx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(this.audioCtx.destination);
                    
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(523.25, this.audioCtx.currentTime); // C5
                    
                    const now = this.audioCtx.currentTime;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.1, now + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 2.5);
                    
                    osc.start(now);
                    osc.stop(now + 2.5);
                } catch (e) {}
            },

            runBreathPhase(index) {
                if (!this.breathActive) return;
                
                const config = this.breathConfig[this.breathTechnique];
                const phase = config.phases[index % config.phases.length];
                
                this.playBreathTone();
                document.getElementById('breath-instruction').textContent = phase.l;
                
                const c1 = document.getElementById('breath-circle');
                const c2 = document.getElementById('breath-circle-inner');
                
                if(c1) {
                    c1.style.transitionDuration = `${phase.d}ms`;
                    c1.style.transform = `scale(${phase.s})`;
                }
                if(c2) {
                    c2.style.transitionDuration = `${phase.d}ms`;
                    c2.style.transform = `scale(${phase.s})`;
                }
                
                const t = setTimeout(() => {
                    this.runBreathPhase(index + 1);
                }, phase.d);
                
                this.breathTimeouts.push(t);
            },

            // Screen Recorder
            async toggleRecording() {
                if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            },

            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: { mediaSource: 'screen' }, 
                        audio: true 
                    });
                    
                    this.mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
                    this.recordedChunks = [];
                    
                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) this.recordedChunks.push(e.data);
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `recording_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.webm`;
                        a.click();
                        URL.revokeObjectURL(url);
                    };
                    
                    // Stop when screen sharing ends
                    stream.getVideoTracks()[0].onended = () => this.stopRecording();
                    
                    this.mediaRecorder.start();
                    this.recordingStartTime = Date.now();
                    
                    // UI Updates
                    document.getElementById('rec-btn').innerHTML = '<i data-lucide="square" class="w-5 h-5 fill-current"></i><span>Stop Recording</span>';
                    document.getElementById('rec-btn').classList.replace('btn-primary', 'bg-red-500');
                    document.getElementById('rec-icon').classList.add('text-red-500');
                    document.getElementById('rec-icon-container').classList.add('animate-pulse');
                    document.getElementById('recording-info').classList.remove('hidden');
                    
                    this.recordingTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - this.recordingStartTime) / 1000);
                        const h = Math.floor(elapsed / 3600);
                        const m = Math.floor((elapsed % 3600) / 60);
                        const s = elapsed % 60;
                        document.getElementById('rec-timer').textContent = 
                            `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    }, 1000);
                    
                    this._rebuildIcons();
                } catch (e) {
                    alert('Could not start recording: ' + e.message);
                }
            },

            stopRecording() {
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                }
                clearInterval(this.recordingTimer);
                
                document.getElementById('rec-btn').innerHTML = '<i data-lucide="circle" class="w-5 h-5 fill-current"></i><span>Start Recording</span>';
                document.getElementById('rec-btn').classList.replace('bg-red-500', 'btn-primary');
                document.getElementById('rec-icon').classList.remove('text-red-500');
                document.getElementById('rec-icon-container').classList.remove('animate-pulse');
                document.getElementById('recording-info').classList.add('hidden');
                document.getElementById('rec-timer').textContent = '00:00:00';
                
                this._rebuildIcons();
            },

            // Calculator
            calcAppend(val) {
                if (this.calcValue === '0' && !['+', '-', '*', '/', '%', '.'].includes(val)) {
                    this.calcValue = val;
                } else {
                    // Prevent multiple operators
                    const lastChar = this.calcValue.slice(-1);
                    const isOperator = ['+', '-', '*', '/', '%'].includes(val);
                    const lastIsOperator = ['+', '-', '*', '/', '%'].includes(lastChar);
                    
                    if (isOperator && lastIsOperator) {
                        this.calcValue = this.calcValue.slice(0, -1) + val;
                    } else {
                        this.calcValue += val;
                    }
                }
                this.updateCalcDisplay();
            },
            
            calcClear() {
                this.calcValue = '0';
                this.calcHistory = '';
                this.updateCalcDisplay();
            },
            
            calcDelete() {
                this.calcValue = this.calcValue.slice(0, -1);
                if (this.calcValue === '') this.calcValue = '0';
                this.updateCalcDisplay();
            },
            
            calcResult() {
                try {
                    const result = new Function('return ' + this.calcValue)();
                    this.calcHistory = this.calcValue + ' =';
                    this.calcValue = String(result);
                    this.updateCalcDisplay();
                } catch (e) {
                    this.calcValue = 'Error';
                    this.updateCalcDisplay();
                    setTimeout(() => { this.calcValue = '0'; this.updateCalcDisplay(); }, 1000);
                }
            },
            
            updateCalcDisplay() {
                const display = document.getElementById('calc-display');
                const history = document.getElementById('calc-history');
                if (display) display.textContent = this.calcValue.replace(/\*/g, '√ó').replace(/\//g, '√∑');
                if (history) history.textContent = this.calcHistory.replace(/\*/g, '√ó').replace(/\//g, '√∑');
            },

            // PDF Merger
            initPDFDrop() {
                const dropZone = document.getElementById('pdf-drop-zone');
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-indigo-500', 'bg-indigo-50/50');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('border-indigo-500', 'bg-indigo-50/50');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-indigo-500', 'bg-indigo-50/50');
                    const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
                    if (files.length) this.processPDFs(files);
                });
            },

            handlePDFs(input) {
                const files = Array.from(input.files);
                this.processPDFs(files);
            },

            processPDFs(files) {
                this.pdfFiles = files;
                const list = document.getElementById('pdf-list');
                const actions = document.getElementById('pdf-actions');
                
                list.classList.remove('hidden');
                actions.classList.remove('hidden');
                
                list.innerHTML = files.map((f, i) => `
                    <div class="flex items-center gap-3 p-3 glass rounded-lg animate-fade-in">
                        <span class="text-xs font-bold text-slate-400 w-6">${i + 1}</span>
                        <i data-lucide="file-text" class="w-4 h-4 text-red-500"></i>
                        <span class="text-sm font-medium truncate flex-1">${f.name}</span>
                        <span class="text-xs text-slate-400">${(f.size / 1024).toFixed(0)} KB</span>
                    </div>
                `).join('');
                
                this._rebuildIcons();
            },

            async mergePDFs() {
                if (this.pdfFiles.length < 2) return;
                
                const btn = document.getElementById('pdf-merge-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Processing...';
                btn.disabled = true;
                this._rebuildIcons();
                
                try {
                    const mergedPdf = await PDFLib.PDFDocument.create();
                    
                    for (const file of this.pdfFiles) {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
                        const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        pages.forEach(page => mergedPdf.addPage(page));
                    }
                    
                    const pdfBytes = await mergedPdf.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `merged_${new Date().toISOString().slice(0,10)}.pdf`;
                    a.click();
                    
                    this.showToast('PDFs merged successfully!');
                } catch (e) {
                    alert('Error merging PDFs: ' + e.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    this._rebuildIcons();
                }
            },

            clearPDFs() {
                this.pdfFiles = [];
                document.getElementById('pdf-list').classList.add('hidden');
                document.getElementById('pdf-actions').classList.add('hidden');
                document.getElementById('pdf-input').value = '';
            },

            // Time Zones
            initZones() {
                const currentHour = new Date().getHours();
                document.getElementById('zone-slider').value = currentHour;
                this.updateZones(currentHour);
            },

            updateZones(val) {
                const zones = [
                    { label: 'Local', zone: Intl.DateTimeFormat().resolvedOptions().timeZone },
                    { label: 'New York', zone: 'America/New_York' },
                    { label: 'London', zone: 'Europe/London' },
                    { label: 'Berlin', zone: 'Europe/Berlin' },
                    { label: 'Dubai', zone: 'Asia/Dubai' },
                    { label: 'Mumbai', zone: 'Asia/Kolkata' },
                    { label: 'Singapore', zone: 'Asia/Singapore' },
                    { label: 'Tokyo', zone: 'Asia/Tokyo' },
                    { label: 'Sydney', zone: 'Australia/Sydney' }
                ];
                
                const now = new Date();
                if (val !== 'now') {
                    now.setHours(parseInt(val));
                    now.setMinutes(0);
                }
                
                const grid = document.getElementById('zone-grid');
                grid.innerHTML = zones.map(z => {
                    const time = now.toLocaleTimeString('en-US', { 
                        timeZone: z.zone, 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    const isNight = parseInt(time) < 6 || parseInt(time) >= 18;
                    
                    return `
                    <div class="glass p-4 rounded-2xl flex flex-col items-center hover:scale-105 transition-transform">
                        <span class="text-[10px] font-black uppercase text-slate-400 mb-1">${z.label}</span>
                        <span class="text-2xl font-black timer-font ${isNight ? 'text-indigo-400' : 'text-amber-500'}">${time}</span>
                        <span class="text-[10px] text-slate-500 mt-1">${z.zone.split('/')[1].replace('_', ' ')}</span>
                    </div>`;
                }).join('');
            },

            setZoneTime(mode) {
                let hour;
                const now = new Date();
                
                if (mode === 'now') {
                    document.getElementById('zone-slider').value = now.getHours();
                    this.updateZones('now');
                    return;
                }

                switch(mode) {
                    case 'morning': hour = 9; break;
                    case 'noon': hour = 12; break;
                    case 'evening': hour = 18; break;
                }
                document.getElementById('zone-slider').value = hour;
                this.updateZones(hour);
            },

            // On Air
            showOnAir(status) {
                const overlay = document.getElementById('onair-overlay');
                const msg = document.getElementById('onair-msg');
                const custom = document.getElementById('custom-status').value;
                
                const messages = {
                    busy: 'ON CALL',
                    focus: 'DEEP WORK',
                    free: 'AVAILABLE'
                };
                
                const colors = {
                    busy: 'from-red-600 to-red-800',
                    focus: 'from-indigo-600 to-purple-800',
                    free: 'from-green-600 to-emerald-800'
                };
                
                msg.textContent = custom || messages[status];
                overlay.className = `fixed inset-0 z-[250] flex-col items-center justify-center text-white p-10 text-center bg-gradient-to-br ${colors[status]}`;
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            },

            // Music Player
            toggleMusic() {
                if (!this.musicAudio) {
                    this.musicAudio = new Audio();
                    this.musicAudio.crossOrigin = "anonymous";
                    this.musicAudio.src = 'https://stream.zeno.fm/0r0xa792kwzuv';
                    this.musicAudio.volume = 0.5;
                    
                    // Setup Visualizer
                    try {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        if (!this.musicCtx) this.musicCtx = new AudioContext();
                        
                        const source = this.musicCtx.createMediaElementSource(this.musicAudio);
                        this.musicAnalyser = this.musicCtx.createAnalyser();
                        this.musicAnalyser.fftSize = 32;
                        
                        source.connect(this.musicAnalyser);
                        this.musicAnalyser.connect(this.musicCtx.destination);
                    } catch(e) {
                        console.log("Visualizer setup failed:", e);
                    }
                }
                
                const btn = document.getElementById('sidebar-play-btn');
                const icon = document.getElementById('music-icon');
                const canvas = document.getElementById('music-viz');
                
                if (this.musicPlaying) {
                    this.musicAudio.pause();
                    this.musicPlaying = false;
                    btn.innerHTML = '<i data-lucide="play" class="w-4 h-4 fill-current"></i>';
                    btn.classList.remove('text-indigo-500', 'bg-indigo-50');
                    
                    if(icon) icon.classList.remove('opacity-0');
                    if(canvas) canvas.classList.add('opacity-0');
                    if(this.vizAnimation) cancelAnimationFrame(this.vizAnimation);
                } else {
                    if (this.musicCtx && this.musicCtx.state === 'suspended') this.musicCtx.resume();
                    this.musicAudio.play().catch(e => this.showToast("Stream unavailable"));
                    this.musicPlaying = true;
                    btn.innerHTML = '<i data-lucide="pause" class="w-4 h-4 fill-current"></i>';
                    btn.classList.add('text-indigo-500', 'bg-indigo-50');
                    
                    if(icon) icon.classList.add('opacity-0');
                    if(canvas) {
                        canvas.classList.remove('opacity-0');
                        this.drawVisualizer();
                    }
                }
                this._rebuildIcons();
            },

            drawVisualizer() {
                if (!this.musicPlaying || !this.musicAnalyser) return;
                const canvas = document.getElementById('music-viz');
                const ctx = canvas.getContext('2d');
                const bufferLength = this.musicAnalyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const draw = () => {
                    if (!this.musicPlaying) return;
                    this.vizAnimation = requestAnimationFrame(draw);
                    this.musicAnalyser.getByteFrequencyData(dataArray);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    const barWidth = (canvas.width / bufferLength) * 2.5;
                    let x = 0;
                    
                    for(let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * canvas.height;
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                        x += barWidth + 1;
                    }
                };
                draw();
            },

            // ‚îÄ‚îÄ STOPWATCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            formatSw(ms) {
                const mins = Math.floor(ms / 60000);
                const secs = Math.floor((ms % 60000) / 1000);
                const cs   = Math.floor((ms % 1000) / 10);
                return `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}.${String(cs).padStart(2,'0')}`;
            },

            toggleStopwatch() {
                if (this.swRunning) {
                    clearInterval(this.swInterval);
                    this.swRunning = false;
                    document.getElementById('sw-btn').textContent = 'Resume';
                    document.getElementById('sw-status').textContent = 'Paused';
                } else {
                    const startTime = Date.now() - this.swElapsed;
                    this.swInterval = setInterval(() => {
                        this.swElapsed = Date.now() - startTime;
                        document.getElementById('sw-display').textContent = this.formatSw(this.swElapsed);
                    }, 10);
                    this.swRunning = true;
                    document.getElementById('sw-btn').textContent = 'Pause';
                    document.getElementById('sw-status').textContent = 'Running';
                    document.getElementById('sw-lap-btn').disabled = false;
                }
            },

            lapStopwatch() {
                if (!this.swRunning) return;
                const lapTime = this.swElapsed - this.swLapStart;
                this.swLaps.push({ total: this.swElapsed, split: lapTime });
                this.swLapStart = this.swElapsed;
                this.renderSwLaps();
            },

            renderSwLaps() {
                const el = document.getElementById('sw-laps');
                if (!el) return;
                if (this.swLaps.length === 0) { el.classList.add('hidden'); return; }
                el.classList.remove('hidden');
                el.innerHTML = [...this.swLaps].reverse().map((lap, i) => {
                    const num = this.swLaps.length - i;
                    return `<div class="flex justify-between items-center py-2 border-b border-slate-200/50 dark:border-slate-700/50 text-sm font-mono">
                        <span class="text-slate-400 font-bold">Lap ${num}</span>
                        <span class="text-slate-500">+${this.formatSw(lap.split)}</span>
                        <span class="font-bold">${this.formatSw(lap.total)}</span>
                    </div>`;
                }).join('');
            },

            resetStopwatch() {
                clearInterval(this.swInterval);
                this.swRunning = false;
                this.swElapsed = 0;
                this.swLapStart = 0;
                this.swLaps = [];
                document.getElementById('sw-display').textContent = '00:00.00';
                document.getElementById('sw-btn').textContent = 'Start';
                document.getElementById('sw-status').textContent = 'Ready';
                document.getElementById('sw-lap-btn').disabled = true;
                this.renderSwLaps();
            },

            // ‚îÄ‚îÄ UNIT CONVERTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            initConverter() {
                this.switchConverterCategory('length');
            },

            switchConverterCategory(cat) {
                this.converterCategory = cat;
                document.querySelectorAll('.conv-cat-btn').forEach(btn => {
                    const active = btn.dataset.cat === cat;
                    btn.classList.toggle('bg-indigo-600', active);
                    btn.classList.toggle('text-white', active);
                    btn.classList.toggle('glass', !active);
                });
                const data = this.converterData[cat];
                const fromSel = document.getElementById('conv-from-unit');
                const toSel   = document.getElementById('conv-to-unit');
                if (!fromSel || !toSel) return;
                const opts = data.units.map((u,i) => `<option value="${u}">${u}</option>`).join('');
                fromSel.innerHTML = opts;
                toSel.innerHTML   = opts;
                // default sensible selections
                if (cat === 'length')  { fromSel.value = 'm';   toSel.value = 'ft'; }
                if (cat === 'weight')  { fromSel.value = 'kg';  toSel.value = 'lb'; }
                if (cat === 'temp')    { fromSel.value = '¬∞C';  toSel.value = '¬∞F'; }
                if (cat === 'volume')  { fromSel.value = 'L';   toSel.value = 'cup'; }
                if (cat === 'speed')   { fromSel.value = 'km/h'; toSel.value = 'mph'; }
                document.getElementById('conv-from-val').value = '';
                document.getElementById('conv-to-val').value = '';
                document.getElementById('conv-formula').textContent = '';
            },

            convertTemp(val, from, to) {
                let c;
                if (from === '¬∞C') c = val;
                else if (from === '¬∞F') c = (val - 32) * 5 / 9;
                else c = val - 273.15;
                if (to === '¬∞C') return c;
                if (to === '¬∞F') return c * 9/5 + 32;
                return c + 273.15;
            },

            convertUnit() {
                const val = parseFloat(document.getElementById('conv-from-val').value);
                const from = document.getElementById('conv-from-unit').value;
                const to   = document.getElementById('conv-to-unit').value;
                const toInput = document.getElementById('conv-to-val');
                const formula = document.getElementById('conv-formula');
                if (isNaN(val)) { toInput.value = ''; formula.textContent = ''; return; }
                let result;
                const cat = this.converterData[this.converterCategory];
                if (cat.special) {
                    result = this.convertTemp(val, from, to);
                } else {
                    result = (val * cat.factors[from]) / cat.factors[to];
                }
                const rounded = parseFloat(result.toPrecision(7));
                toInput.value = rounded;
                formula.textContent = `${val} ${from} = ${rounded} ${to}`;
            },

            convertUnitReverse() {
                const val = parseFloat(document.getElementById('conv-to-val').value);
                const from = document.getElementById('conv-to-unit').value;
                const to   = document.getElementById('conv-from-unit').value;
                const toInput = document.getElementById('conv-from-val');
                const formula = document.getElementById('conv-formula');
                if (isNaN(val)) { toInput.value = ''; formula.textContent = ''; return; }
                let result;
                const cat = this.converterData[this.converterCategory];
                if (cat.special) {
                    result = this.convertTemp(val, from, to);
                } else {
                    result = (val * cat.factors[from]) / cat.factors[to];
                }
                const rounded = parseFloat(result.toPrecision(7));
                toInput.value = rounded;
                formula.textContent = `${val} ${from} = ${rounded} ${to}`;
            },

            swapConverter() {
                const fromSel = document.getElementById('conv-from-unit');
                const toSel   = document.getElementById('conv-to-unit');
                const fromVal = document.getElementById('conv-from-val');
                const toVal   = document.getElementById('conv-to-val');
                [fromSel.value, toSel.value] = [toSel.value, fromSel.value];
                [fromVal.value, toVal.value] = [toVal.value, fromVal.value];
                this.convertUnit();
            },

            // ‚îÄ‚îÄ COLOR PICKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            initColorPicker() {
                try {
                    this.cpSwatches = JSON.parse(localStorage.getItem('wd_color_swatches') || '[]');
                } catch(e) { this.cpSwatches = []; }
                this.cpApplyColor(79, 70, 229);
                this.renderSwatches();
            },

            cpApplyColor(r, g, b) {
                this.cpColor = { r, g, b };
                const hex = '#' + [r,g,b].map(x => x.toString(16).padStart(2,'0')).join('');
                const [h, s, l] = this.rgbToHsl(r, g, b);

                const inp = document.getElementById('cp-input');
                const prev = document.getElementById('cp-preview');
                const hexEl = document.getElementById('cp-hex');
                const rgbEl = document.getElementById('cp-rgb');
                const hslEl = document.getElementById('cp-hsl');
                const rSlider = document.getElementById('cp-r');
                const gSlider = document.getElementById('cp-g');
                const bSlider = document.getElementById('cp-b');

                if (inp) inp.value = hex;
                if (prev) prev.style.background = hex;
                if (hexEl) hexEl.value = hex;
                if (rgbEl) rgbEl.value = `rgb(${r}, ${g}, ${b})`;
                if (hslEl) hslEl.value = `hsl(${h}, ${s}%, ${l}%)`;
                if (rSlider) { rSlider.value = r; document.getElementById('cp-r-val').textContent = r; }
                if (gSlider) { gSlider.value = g; document.getElementById('cp-g-val').textContent = g; }
                if (bSlider) { bSlider.value = b; document.getElementById('cp-b-val').textContent = b; }
            },

            updateColorFromPicker() {
                const hex = document.getElementById('cp-input').value;
                const { r, g, b } = this.hexToRgb(hex);
                this.cpApplyColor(r, g, b);
            },

            updateColorFromHex() {
                const hex = document.getElementById('cp-hex').value.trim();
                if (!/^#[0-9a-fA-F]{6}$/.test(hex)) return;
                const { r, g, b } = this.hexToRgb(hex);
                this.cpApplyColor(r, g, b);
            },

            updateColorFromSliders() {
                const r = parseInt(document.getElementById('cp-r').value);
                const g = parseInt(document.getElementById('cp-g').value);
                const b = parseInt(document.getElementById('cp-b').value);
                this.cpApplyColor(r, g, b);
            },

            copyColorFormat(format) {
                const { r, g, b } = this.cpColor;
                let text;
                if (format === 'hex') text = document.getElementById('cp-hex').value;
                else if (format === 'rgb') text = `rgb(${r}, ${g}, ${b})`;
                else { const [h,s,l] = this.rgbToHsl(r,g,b); text = `hsl(${h}, ${s}%, ${l}%)`; }
                navigator.clipboard.writeText(text).then(() => this.showToast(`Copied: ${text}`));
            },

            saveColorSwatch() {
                const { r, g, b } = this.cpColor;
                const hex = '#' + [r,g,b].map(x => x.toString(16).padStart(2,'0')).join('');
                if (this.cpSwatches.includes(hex)) return;
                this.cpSwatches.push(hex);
                if (this.cpSwatches.length > 16) this.cpSwatches.shift();
                localStorage.setItem('wd_color_swatches', JSON.stringify(this.cpSwatches));
                this.renderSwatches();
            },

            removeColorSwatch(index) {
                this.cpSwatches.splice(index, 1);
                localStorage.setItem('wd_color_swatches', JSON.stringify(this.cpSwatches));
                this.renderSwatches();
            },

            renderSwatches() {
                const el = document.getElementById('cp-swatches');
                if (!el) return;
                if (this.cpSwatches.length === 0) {
                    el.innerHTML = '<span class="text-xs text-slate-400 italic">No saved swatches yet.</span>';
                    return;
                }
                el.innerHTML = this.cpSwatches.map((hex, i) => `
                    <div class="relative group">
                        <div class="color-swatch" style="background:${hex}" onclick="app.loadSwatch('${hex}')" title="${hex}"></div>
                        <button onclick="app.removeColorSwatch(${i})" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[8px] items-center justify-center hidden group-hover:flex leading-none">&times;</button>
                    </div>
                `).join('');
            },

            loadSwatch(hex) {
                const { r, g, b } = this.hexToRgb(hex);
                this.cpApplyColor(r, g, b);
            },

            hexToRgb(hex) {
                const clean = hex.replace('#','');
                return {
                    r: parseInt(clean.slice(0,2), 16),
                    g: parseInt(clean.slice(2,4), 16),
                    b: parseInt(clean.slice(4,6), 16)
                };
            },

            rgbToHsl(r, g, b) {
                r /= 255; g /= 255; b /= 255;
                const max = Math.max(r,g,b), min = Math.min(r,g,b);
                let h, s, l = (max + min) / 2;
                if (max === min) { h = s = 0; }
                else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch(max) {
                        case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                        case g: h = ((b - r) / d + 2) / 6; break;
                        case b: h = ((r - g) / d + 4) / 6; break;
                    }
                }
                return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
            },

            // ‚îÄ‚îÄ Focus Town ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            initFocusTown() {
                this.ftMinutes = parseInt(localStorage.getItem('wd_ft_minutes') || '0');
                this.ftSessions = parseInt(localStorage.getItem('wd_ft_sessions') || '0');
                this.ftRenderScene();
                this.ftUpdateStats();
            },

            ftGetStage(minutes) {
                const t = this.ftStageThresholds;
                let idx = 0;
                for (let i = t.length - 1; i >= 0; i--) {
                    if (minutes >= t[i]) { idx = i; break; }
                }
                return {
                    index: idx,
                    name: this.ftStageNames[idx],
                    emoji: this.ftStageEmoji[idx],
                    prevAt: t[idx],
                    nextAt: idx < t.length - 1 ? t[idx + 1] : null,
                    nextName: idx < t.length - 1 ? this.ftStageNames[idx + 1] : null
                };
            },

            ftGetCitizenCount(minutes) {
                return Math.min(Math.floor(minutes * 0.055) + 2, 50);
            },

            ftRenderScene() {
                const scene = document.getElementById('ft-scene');
                if (!scene) return;
                const stage = this.ftGetStage(this.ftMinutes);
                const citizens = this.ftGetCitizenCount(this.ftMinutes);
                const buildings = this.ftBuildings[stage.index];

                // Sky sun/moon decoration
                const skyDecor = `<span class="ft-sky-obj" style="top:10px;left:16px;font-size:1.8rem;opacity:0.85;">‚òÄÔ∏è</span>`;

                // Clouds ‚Äî 2-3 with staggered timings
                const cloudData = [
                    { delay: '0s', dur: '28s', top: '12px' },
                    { delay: '-10s', dur: '38s', top: '24px' },
                    { delay: '-20s', dur: '32s', top: '8px' }
                ];
                const cloudHtml = cloudData.map(c =>
                    `<span class="ft-cloud ft-sky-obj" style="animation-duration:${c.dur};animation-delay:${c.delay};top:${c.top}">‚òÅÔ∏è</span>`
                ).join('');

                // Mountains (stage ‚â• 1)
                const mtns = stage.index >= 1
                    ? `<div class="ft-mountains">üèîÔ∏èüèîÔ∏èüèîÔ∏è</div>`
                    : '';

                // Buildings
                const bldgHtml = buildings.map(b =>
                    `<span class="ft-building" style="font-size:${b.s}rem">${b.e}</span>`
                ).join('');

                // Citizens
                const citizenHtml = this.ftBuildCitizens(citizens);

                // Vehicles (stage ‚â• 2)
                const vehicleHtml = stage.index >= 2 ? this.ftBuildVehicles(stage.index) : '';

                scene.innerHTML = `
                    ${skyDecor}
                    ${cloudHtml}
                    ${mtns}
                    <div class="ft-building-row">${bldgHtml}</div>
                    <div class="ft-ground"></div>
                    <div class="ft-road"><div class="ft-road-line"></div></div>
                    <div class="ft-citizen-row">${citizenHtml}${vehicleHtml}</div>
                `;
            },

            ftBuildCitizens(count) {
                const emojis = ['üö∂','üßç','üèÉ','üë§','üö∂‚Äç‚ôÄÔ∏è','üßë'];
                let html = '';
                for (let i = 0; i < count; i++) {
                    const isRev = Math.random() < 0.5;
                    const dur = (12 + Math.random() * 20).toFixed(1) + 's';
                    const delay = -(Math.random() * 25).toFixed(1) + 's';
                    const bottom = (2 + Math.random() * 6).toFixed(0) + 'px';
                    const em = emojis[i % emojis.length];
                    html += `<span class="ft-citizen${isRev ? ' rev' : ''}" style="animation-duration:${dur};animation-delay:${delay};bottom:${bottom}">${em}</span>`;
                }
                return html;
            },

            ftBuildVehicles(stageIdx) {
                const configs = [
                    [],
                    [],
                    // Stage 2 ‚Äî Town
                    [{ e:'üöó', rev:false, dur:'18s', delay:'-3s' }],
                    // Stage 3 ‚Äî City
                    [{ e:'üöó', rev:false, dur:'14s', delay:'-1s' }, { e:'üöå', rev:true, dur:'22s', delay:'-8s' }],
                    // Stage 4 ‚Äî Metropolis
                    [{ e:'üöó', rev:false, dur:'12s', delay:'-2s' }, { e:'üöï', rev:false, dur:'16s', delay:'-6s' }, { e:'üöå', rev:true, dur:'20s', delay:'-4s' }, { e:'üöê', rev:true, dur:'24s', delay:'-12s' }]
                ];
                const vlist = configs[Math.min(stageIdx, configs.length - 1)];
                return vlist.map(v =>
                    `<span class="ft-vehicle${v.rev ? ' rev' : ''}" style="animation-duration:${v.dur};animation-delay:${v.delay}">${v.e}</span>`
                ).join('');
            },

            ftUpdateStats() {
                const stage = this.ftGetStage(this.ftMinutes);
                const citizens = this.ftGetCitizenCount(this.ftMinutes);

                // Header chips
                const emojiEl = document.getElementById('ft-stage-emoji');
                const badgeEl = document.getElementById('ft-stage-badge');
                const chipEl = document.getElementById('ft-total-chip');
                if (emojiEl) emojiEl.textContent = stage.emoji;
                if (badgeEl) badgeEl.textContent = stage.name;
                if (chipEl) chipEl.textContent = `${this.ftMinutes} min total`;

                // Stage name labels
                const sNameEl = document.getElementById('ft-stage-name');
                const nNameEl = document.getElementById('ft-next-stage-name');
                if (sNameEl) sNameEl.textContent = stage.name;
                if (nNameEl) nNameEl.textContent = stage.nextName || '‚úì Max';

                // Progress bar
                const prog = document.getElementById('ft-progress-bar');
                const label = document.getElementById('ft-progress-label');
                if (stage.nextAt !== null) {
                    const span = stage.nextAt - stage.prevAt;
                    const done = this.ftMinutes - stage.prevAt;
                    const pct = Math.min(100, Math.round((done / span) * 100));
                    if (prog) prog.style.width = pct + '%';
                    if (label) label.textContent = `${stage.nextAt - this.ftMinutes} min to unlock`;
                } else {
                    if (prog) prog.style.width = '100%';
                    if (label) label.textContent = 'Maximum stage reached! üèÜ';
                }

                // Stats cards
                const ccEl = document.getElementById('ft-citizen-count');
                const scEl = document.getElementById('ft-sessions-count');
                const tmEl = document.getElementById('ft-total-min');
                if (ccEl) ccEl.textContent = citizens;
                if (scEl) scEl.textContent = this.ftSessions;
                if (tmEl) {
                    const h = Math.floor(this.ftMinutes / 60);
                    const m = this.ftMinutes % 60;
                    tmEl.textContent = h > 0 ? `${h}h ${m}m` : `${m}m`;
                }

                // Milestones highlight
                document.querySelectorAll('.ft-milestone').forEach(el => {
                    const s = parseInt(el.dataset.stage);
                    if (s <= stage.index) {
                        el.classList.add('bg-indigo-100', 'dark:bg-indigo-900/30', 'text-indigo-700', 'dark:text-indigo-300');
                        el.classList.remove('text-slate-400', 'opacity-50');
                    } else {
                        el.classList.remove('bg-indigo-100', 'dark:bg-indigo-900/30', 'text-indigo-700', 'dark:text-indigo-300');
                        el.classList.add('text-slate-400', 'opacity-50');
                    }
                });
            },

            ftSetMode(minutes) {
                this.ftMode = minutes;
                this.ftTime = minutes * 60;
                this.ftUpdateTimerDisplay();
                document.querySelectorAll('.ft-mode-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('hover:bg-white/20');
                    if (parseInt(btn.dataset.time) === minutes) {
                        btn.classList.add('bg-indigo-600', 'text-white');
                        btn.classList.remove('hover:bg-white/20');
                    }
                });
            },

            ftToggleTimer() {
                if (this.ftRunning) this.ftPause();
                else this.ftStart();
            },

            ftStart() {
                this.ftRunning = true;
                const btn = document.getElementById('ft-btn');
                const status = document.getElementById('ft-timer-status');
                const scene = document.getElementById('ft-scene');
                if (btn) btn.textContent = 'Pause Focus';
                if (status) { status.textContent = 'Focusing‚Ä¶'; status.classList.add('animate-pulse'); }
                if (scene) scene.classList.add('ft-session-active');
                this.ftInterval = setInterval(() => this.ftTick(), 1000);
            },

            ftPause() {
                this.ftRunning = false;
                clearInterval(this.ftInterval);
                const btn = document.getElementById('ft-btn');
                const status = document.getElementById('ft-timer-status');
                const scene = document.getElementById('ft-scene');
                if (btn) btn.textContent = 'Resume Focus';
                if (status) { status.textContent = 'Paused'; status.classList.remove('animate-pulse'); }
                if (scene) scene.classList.remove('ft-session-active');
            },

            ftResetTimer() {
                this.ftPause();
                this.ftTime = this.ftMode * 60;
                this.ftUpdateTimerDisplay();
                const btn = document.getElementById('ft-btn');
                const status = document.getElementById('ft-timer-status');
                if (btn) btn.textContent = 'Start Focusing';
                if (status) { status.textContent = 'Ready to Focus'; status.classList.remove('animate-pulse'); }
            },

            ftTick() {
                this.ftTime--;
                this.ftUpdateTimerDisplay();
                if (this.ftTime <= 0) this.ftCompleteSession();
            },

            ftUpdateTimerDisplay() {
                const el = document.getElementById('ft-timer-display');
                if (!el) return;
                const m = Math.floor(this.ftTime / 60);
                const s = this.ftTime % 60;
                el.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            },

            ftCompleteSession() {
                const prevStage = this.ftGetStage(this.ftMinutes).index;
                this.ftMinutes += this.ftMode;
                this.ftSessions++;
                localStorage.setItem('wd_ft_minutes', this.ftMinutes);
                localStorage.setItem('wd_ft_sessions', this.ftSessions);

                const newStage = this.ftGetStage(this.ftMinutes);
                const stagedUp = newStage.index > prevStage;

                this.ftResetTimer();
                this.ftRenderScene();
                this.ftUpdateStats();

                if (stagedUp) {
                    this.showToast(`${newStage.emoji} Your village grew into a ${newStage.name}!`);
                    // Flash the scene
                    const flash = document.getElementById('ft-unlock-flash');
                    const scene = document.getElementById('ft-scene');
                    if (flash) {
                        flash.style.opacity = '1';
                        setTimeout(() => { flash.style.opacity = '0'; }, 700);
                    }
                    if (scene) {
                        scene.style.animation = 'ft-stage-up 0.8s ease';
                        setTimeout(() => { scene.style.animation = ''; }, 800);
                    }
                } else {
                    const citizens = this.ftGetCitizenCount(this.ftMinutes);
                    this.showToast(`Focus session complete! +${this.ftMode} min ‚Äî ${citizens} citizens üè†`);
                }
            },

            ftResetProgress() {
                if (!confirm('Reset all Focus Town progress? Your town will go back to a village.')) return;
                this.ftMinutes = 0;
                this.ftSessions = 0;
                localStorage.removeItem('wd_ft_minutes');
                localStorage.removeItem('wd_ft_sessions');
                this.ftRenderScene();
                this.ftUpdateStats();
                this.showToast('Focus Town reset. Build your village again! üåæ');
            },

            // Utilities
            showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl z-[500] animate-bounce';
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Initialize on load
        window.addEventListener('load', () => app.init());
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8626644983261966"
     crossorigin="anonymous"></script>
